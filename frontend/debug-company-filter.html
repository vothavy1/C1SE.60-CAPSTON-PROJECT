<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸ” Debug Company Filter</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
        }
        .box {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        h2 { color: #00ff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        button:hover { background: #00cc00; }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
        pre {
            background: #000;
            padding: 15px;
            border: 1px solid #333;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” DEBUG COMPANY FILTER</h1>
    
    <div class="box">
        <h2>BÆ¯á»šC 1: Kiá»ƒm tra Token</h2>
        <button onclick="checkToken()">ğŸ”‘ Check My Token</button>
        <pre id="tokenInfo"></pre>
    </div>

    <div class="box">
        <h2>BÆ¯á»šC 2: Test API vá»›i Current Token</h2>
        <button onclick="testAPI()">ğŸš€ Test Get Candidates API</button>
        <pre id="apiResult"></pre>
    </div>

    <div class="box">
        <h2>BÆ¯á»šC 3: Giáº£i phÃ¡p</h2>
        <button onclick="location.href='quick-logout.html'">ğŸšª ÄÄƒng xuáº¥t & Login láº¡i</button>
        <button onclick="fixData()">ğŸ”§ Fix Database (Update Candidate 16)</button>
    </div>

    <script>
        function log(id, msg, type = 'info') {
            const el = document.getElementById(id);
            const colors = { error: '#ff0000', success: '#00ff00', warning: '#ffaa00', info: '#00ff00' };
            el.innerHTML += `<span style="color: ${colors[type]}">${msg}</span>\n`;
        }

        function clear(id) {
            document.getElementById(id).innerHTML = '';
        }

        function checkToken() {
            clear('tokenInfo');
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('tokenInfo', 'âŒ KHÃ”NG CÃ“ TOKEN!', 'error');
                log('tokenInfo', 'Báº¡n chÆ°a Ä‘Äƒng nháº­p.', 'error');
                return null;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                log('tokenInfo', 'âœ… TOKEN Tá»’N Táº I\n', 'success');
                log('tokenInfo', 'PAYLOAD:', 'info');
                log('tokenInfo', JSON.stringify(payload, null, 2), 'info');
                log('tokenInfo', '\nğŸ“‹ PHÃ‚N TÃCH:', 'info');
                log('tokenInfo', `User ID: ${payload.id}`, 'info');
                log('tokenInfo', `Username: ${payload.username}`, 'info');
                log('tokenInfo', `Role: ${payload.role}`, 'info');
                
                if (payload.company_id) {
                    log('tokenInfo', `Company ID: ${payload.company_id} âœ…`, 'success');
                    log('tokenInfo', `\nâœ… Token cÃ³ company_id = ${payload.company_id}`, 'success');
                    
                    if (payload.company_id === 1) {
                        log('tokenInfo', 'âœ… ÄÃ¢y lÃ  tÃ i khoáº£n CS60 (company 1)', 'success');
                        log('tokenInfo', 'âœ… KHÃ”NG NÃŠN tháº¥y candidate ID 16 (company 2)!', 'success');
                    } else {
                        log('tokenInfo', `âš ï¸ ÄÃ¢y lÃ  company ${payload.company_id}, KHÃ”NG PHáº¢I CS60!`, 'warning');
                    }
                } else {
                    log('tokenInfo', 'Company ID: KHÃ”NG CÃ“ âŒ', 'error');
                    log('tokenInfo', '\nâŒ Token THIáº¾U company_id!', 'error');
                    log('tokenInfo', 'Cáº§n Ä‘Äƒng xuáº¥t vÃ  Ä‘Äƒng nháº­p láº¡i!', 'error');
                }
                
                return payload;
            } catch (e) {
                log('tokenInfo', `âŒ Lá»–I DECODE: ${e.message}`, 'error');
                return null;
            }
        }

        async function testAPI() {
            clear('apiResult');
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('apiResult', 'âŒ KhÃ´ng cÃ³ token!', 'error');
                return;
            }

            const payload = JSON.parse(atob(token.split('.')[1]));
            log('apiResult', `ğŸš€ Testing API vá»›i token company_id = ${payload.company_id}\n`, 'info');

            try {
                const response = await fetch('http://localhost:5000/api/candidates?limit=100', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    log('apiResult', `âœ… API SUCCESS! Status: ${response.status}\n`, 'success');
                    log('apiResult', `Total: ${data.data.length} candidates\n`, 'info');

                    const byCompany = {};
                    data.data.forEach(c => {
                        byCompany[c.company_id] = (byCompany[c.company_id] || 0) + 1;
                    });

                    log('apiResult', 'ğŸ“Š BREAKDOWN BY COMPANY:', 'info');
                    Object.keys(byCompany).forEach(cid => {
                        log('apiResult', `  Company ${cid}: ${byCompany[cid]} candidates`, 'info');
                    });

                    // Check if bug exists
                    const candidate16 = data.data.find(c => c.candidate_id === 16);
                    if (candidate16) {
                        log('apiResult', `\nâš ï¸ TÃ¬m tháº¥y Candidate ID 16:`, 'warning');
                        log('apiResult', `   Name: ${candidate16.first_name} ${candidate16.last_name}`, 'warning');
                        log('apiResult', `   Company: ${candidate16.company_id}`, 'warning');
                        
                        if (payload.company_id === 1 && candidate16.company_id === 2) {
                            log('apiResult', '\nâŒ BUG XÃC NHáº¬N!', 'error');
                            log('apiResult', 'User company 1 tháº¥y candidate company 2!', 'error');
                            log('apiResult', 'Backend filter KHÃ”NG HOáº T Äá»˜NG!', 'error');
                        }
                    } else {
                        log('apiResult', '\nâœ… KhÃ´ng tháº¥y candidate ID 16', 'success');
                        log('apiResult', 'Filter hoáº¡t Ä‘á»™ng Ä‘Ãºng!', 'success');
                    }

                    log('apiResult', '\nğŸ“¦ SAMPLE DATA (first 3):', 'info');
                    data.data.slice(0, 3).forEach(c => {
                        log('apiResult', `  ID ${c.candidate_id}: ${c.first_name} ${c.last_name} (Company ${c.company_id})`, 'info');
                    });

                } else {
                    log('apiResult', `âŒ API ERROR: ${response.status}`, 'error');
                    log('apiResult', JSON.stringify(data, null, 2), 'error');
                }

            } catch (e) {
                log('apiResult', `âŒ FETCH ERROR: ${e.message}`, 'error');
            }
        }

        function fixData() {
            alert('âš ï¸ Chá»©c nÄƒng nÃ y cáº§n cháº¡y SQL command.\n\nHÃ£y cháº¡y trong terminal:\n\ndocker exec -it cs60_mysql mysql -u cs60user -pcs60password -D cs60_recruitment -e "UPDATE candidates SET company_id = 1 WHERE candidate_id = 16;"');
        }

        // Auto check on load
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                checkToken();
            } else {
                document.getElementById('tokenInfo').innerHTML = '<span style="color:#ff0000">âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p!</span>';
            }
        });
    </script>
</body>
</html>
