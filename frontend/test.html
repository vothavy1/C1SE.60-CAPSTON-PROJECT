<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B√†i Thi - ExamPro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, main, header, footer, section, aside {
      transition: opacity 0.3s ease;
    }

    .alert-box, .cheat-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -60%);
      background: linear-gradient(135deg, #2b2bff, #a16eff);
      color: #fff;
      padding: 20px 35px;
      border-radius: 16px;
      box-shadow: 0 0 25px rgba(0,0,0,0.3);
      font-size: 18px;
      font-weight: 500;
      text-align: center;
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .alert-box.show, .cheat-alert.show {
      opacity: 1;
      transform: translate(-50%, -50%);
    }

    .cheat-alert a {
      display: inline-block;
      margin-top: 10px;
      background-color: #f87171;
      padding: 6px 12px;
      border-radius: 8px;
      text-decoration: none;
      color: white;
      font-weight: 500;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-indigo-800 min-h-screen text-white font-sans">

  <!-- Th√¥ng b√°o b·∫≠t camera -->
  <div id="cameraAlert" class="alert-box hidden">
    ‚ö†Ô∏è Vui l√≤ng b·∫≠t camera ƒë·ªÉ x√°c th·ª±c tr∆∞·ªõc khi ti·∫øp t·ª•c!
  </div>

  <!-- Th√¥ng b√°o gian l·∫≠n -->
  <div id="cheatAlert" class="cheat-alert hidden">
    ‚ö†Ô∏è B·∫°n c√≥ h√†nh vi gian l·∫≠n!<br>
    <a href="exam.html">Quay l·∫°i trang ch·ªß</a>
  </div>

  <header id="header" class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-10 border-b border-purple-400/30 relative">
    <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-6">
      <h1 class="text-2xl font-bold text-white tracking-wide">B√†i Thi To√°n - ExamPro</h1>
      <div class="flex items-center gap-4">
        <div id="timer" class="text-yellow-300 font-semibold text-xl">45:00</div>

        <div class="relative w-32 h-24 border-2 border-purple-300 rounded-lg overflow-hidden bg-purple-900/30 shadow-inner">
          <video id="examCam" autoplay playsinline muted style="width:100%;height:100%;display:none;"></video>
          <div id="camPlaceholder" class="absolute inset-0 flex items-center justify-center text-purple-300 text-sm">üì∑ T·∫Øt</div>
        </div>

        <button id="toggleCamBtn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-3 py-2 rounded-lg text-sm hover:opacity-90 transition">
          B·∫≠t camera
        </button>

        <a href="exam.html" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition">
          Quay l·∫°i
        </a>
      </div>
    </div>
  </header>

  <main id="main" class="max-w-6xl mx-auto mt-10 grid grid-cols-12 gap-6 p-4">
    <aside class="col-span-3 bg-white/10 rounded-2xl p-5 border border-purple-400/30 backdrop-blur-md shadow-lg">
      <h3 class="text-lg font-semibold mb-4 text-purple-200">Danh s√°ch c√¢u h·ªèi</h3>
      <div id="questionNav" class="grid grid-cols-5 gap-3"></div>
    </aside>

    <section class="col-span-9 bg-white/10 rounded-2xl p-8 border border-purple-400/30 backdrop-blur-md shadow-lg relative">
      <div id="questionArea" class="pointer-events-none opacity-50"></div>
    </section>
  </main>

  <footer id="footer" class="text-center py-6 text-purple-200 mt-8 border-t border-purple-500/30">
    ¬© 2025 by C1SE.60
  </footer>

  <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:5000/api';
    
    // Get auth headers with JWT token
    function getAuthHeaders() {
      const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      };
    }

    // Get test ID from URL parameters
    function getTestIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('testId');
    }

    // Global variables
    let testData = null;
    let questions = [];
    let testDuration = 45; // Default 45 minutes

    let currentQuestion = 0;
    const questionArea = document.getElementById("questionArea");
    const questionNav = document.getElementById("questionNav");
    const timerEl = document.getElementById("timer");
    const alertBox = document.getElementById("cameraAlert");
    const cheatAlert = document.getElementById("cheatAlert");
    const cam = document.getElementById("examCam");
    const camPlaceholder = document.getElementById("camPlaceholder");
    const btn = document.getElementById("toggleCamBtn");

    let cameraEnabled = false;
    let selectedAnswers = {};
    let stream = null;
    let examDisabled = false;

    // Load test data from API
    async function loadTestData() {
      const testId = getTestIdFromUrl();
      
      if (!testId) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi. Vui l√≤ng quay l·∫°i danh s√°ch ƒë·ªÅ thi.');
        window.location.href = 'exam.html';
        return;
      }

      try {
        // Show loading
        questionArea.innerHTML = `
          <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            <p class="text-white mt-2">ƒêang t·∫£i ƒë·ªÅ thi...</p>
          </div>
        `;

        // Fetch test details
        const testResponse = await fetch(`${API_BASE_URL}/tests/${testId}`, {
          headers: getAuthHeaders()
        });

        if (!testResponse.ok) {
          throw new Error(`L·ªói t·∫£i ƒë·ªÅ thi: ${testResponse.status}`);
        }

        testData = await testResponse.json();
        console.log('Test data loaded:', testData);

        // Extract test info
        const test = testData.data || testData;
        testDuration = test.duration_minutes || test.duration || 45;

        // Fetch questions for this test
        const questionsResponse = await fetch(`${API_BASE_URL}/tests/${testId}/questions`, {
          headers: getAuthHeaders()
        });

        if (!questionsResponse.ok) {
          throw new Error(`L·ªói t·∫£i c√¢u h·ªèi: ${questionsResponse.status}`);
        }

        const questionsData = await questionsResponse.json();
        console.log('Questions data loaded:', questionsData);

        // Process questions data
        questions = processQuestionsData(questionsData);

        if (questions.length === 0) {
          throw new Error('ƒê·ªÅ thi n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o.');
        }

        // Initialize the exam
        initializeExam();

      } catch (error) {
        console.error('Error loading test:', error);
        questionArea.innerHTML = `
          <div class="text-center py-8">
            <div class="bg-red-500/20 border border-red-400 rounded-lg p-6">
              <h4 class="text-red-200 text-lg font-semibold mb-2">L·ªói t·∫£i ƒë·ªÅ thi</h4>
              <p class="text-red-300">${error.message}</p>
              <button onclick="loadTestData()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                Th·ª≠ l·∫°i
              </button>
              <a href="exam.html" class="mt-4 ml-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition inline-block">
                Quay l·∫°i
              </a>
            </div>
          </div>
        `;
      }
    }

    // Process questions data from API response
    function processQuestionsData(data) {
      let questionsArray = [];
      
      if (data.success && data.data && Array.isArray(data.data)) {
        questionsArray = data.data;
      } else if (Array.isArray(data.data)) {
        questionsArray = data.data;
      } else if (Array.isArray(data)) {
        questionsArray = data;
      }

      return questionsArray.map((q, index) => ({
        id: q.question_id || q.id || (index + 1),
        text: q.question_text || q.text || q.question || 'C√¢u h·ªèi kh√¥ng c√≥ n·ªôi dung',
        options: q.options || [q.option_a, q.option_b, q.option_c, q.option_d].filter(Boolean) || [],
        answer: q.correct_answer || q.answer || 0,
        type: q.question_type || q.type || 'multiple_choice'
      }));
    }

    // Initialize exam interface
    function initializeExam() {
      // Update timer with actual test duration
      totalSeconds = testDuration * 60;
      
      // Render questions navigation
      renderQuestionNavigation();
      
      // Show first question
      showQuestion(0);
      
      // Enable camera area (still requires user to click)
      questionArea.classList.remove("pointer-events-none", "opacity-50");
      questionArea.classList.add("opacity-30");
      
      // Show instruction message
      questionArea.innerHTML = `
        <div class="text-center py-8">
          <div class="bg-yellow-500/20 border border-yellow-400 rounded-lg p-6">
            <h4 class="text-yellow-200 text-lg font-semibold mb-2">üöÄ ƒê√£ s·∫µn s√†ng l√†m b√†i thi</h4>
            <p class="text-yellow-300">Vui l√≤ng b·∫≠t camera ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i.</p>
            <p class="text-yellow-300 text-sm mt-2">Th·ªùi gian: ${testDuration} ph√∫t | S·ªë c√¢u h·ªèi: ${questions.length}</p>
          </div>
        </div>
      `;
    }

    // Render question navigation
    function renderQuestionNavigation() {
      questionNav.innerHTML = '';
      questions.forEach((q, i) => {
        const b = document.createElement("button");
        b.textContent = i + 1;
        b.className = "bg-purple-800/60 text-white py-2 rounded-lg hover:bg-purple-600 transition font-semibold";
        b.addEventListener("click", () => {
          if (examDisabled) return;
          if(cameraEnabled) showQuestion(i);
        });
        questionNav.appendChild(b);
      });
    }

    // This function is now called by renderQuestionNavigation() after loading data

    function showQuestion(i){
      currentQuestion = i;
      const q = questions[i];
      questionArea.innerHTML = `
        <h2 class="text-2xl font-semibold mb-6 text-white">${q.text}</h2>
        <div class="space-y-3">
          ${q.options.map((opt, idx) => `
            <label class="flex items-center gap-3 bg-white/10 p-3 rounded-lg cursor-pointer hover:bg-purple-700/40 transition">
              <input type="radio" name="q${q.id}" value="${idx}" ${selectedAnswers[q.id]==idx?"checked":""} class="accent-purple-400">
              <span>${opt}</span>
            </label>
          `).join("")}
        </div>
        <div class="flex justify-between mt-8">
          <button class="bg-indigo-500 px-5 py-2 rounded-lg hover:bg-indigo-600 transition" ${i===0?"disabled":""} onclick="showQuestion(${i-1})">‚¨Ö Tr∆∞·ªõc</button>
          <button class="bg-indigo-500 px-5 py-2 rounded-lg hover:bg-indigo-600 transition" ${i===questions.length-1?"disabled":""} onclick="showQuestion(${i+1})">Ti·∫øp ‚û°</button>
        </div>
      `;
      document.querySelectorAll(`input[name='q${q.id}']`).forEach(inp=>{
        inp.addEventListener("change", e=>selectedAnswers[q.id]=parseInt(e.target.value));
      });
    }

    // b·ªô ƒë·∫øm gi·ªù (will be set by loadTestData)
    let totalSeconds = 45*60;
    const countdown = setInterval(()=>{
      totalSeconds--;
      const m = String(Math.floor(totalSeconds/60)).padStart(2,"0");
      const s = String(totalSeconds%60).padStart(2,"0");
      timerEl.textContent = `${m}:${s}`;
    },1000);

    function showAlert(){
      alertBox.classList.remove("hidden");
      alertBox.classList.add("show");
      setTimeout(()=>alertBox.classList.remove("show"),2500);
    }

    // Toggle camera
    btn.addEventListener("click", async ()=>{
      if(cameraEnabled) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:true});
        cam.srcObject = stream;
        cam.style.display = "block";
        cam.play();
        camPlaceholder.style.display = "none";
        btn.textContent = "Camera ƒëang b·∫≠t";
        btn.disabled = true;
        cameraEnabled = true;
        questionArea.classList.remove("pointer-events-none","opacity-50","opacity-30");
        
        // Start the exam - show first question
        if (questions.length > 0) {
          showQuestion(0);
        }
      }catch(err){
        alert("Kh√¥ng th·ªÉ b·∫≠t camera: "+err.message);
      }
    });

    document.addEventListener("click", e=>{
      if(!cameraEnabled && !btn.contains(e.target)) showAlert();
    });

    // Ph√°t hi·ªán gian l·∫≠n
    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden && !examDisabled){
        examDisabled = true;
        cheatAlert.classList.remove("hidden");
        cheatAlert.classList.add("show");

        // ·∫®n to√†n b·ªô giao di·ªán thi
        document.getElementById("header").style.opacity = 0.2;
        document.getElementById("main").style.opacity = 0.2;
        document.getElementById("footer").style.opacity = 0.2;
        questionArea.classList.add("pointer-events-none");
        btn.disabled = true;
      }
    });

    // Load test data when page loads
    document.addEventListener('DOMContentLoaded', loadTestData);
  </script>
</body>
</html>
