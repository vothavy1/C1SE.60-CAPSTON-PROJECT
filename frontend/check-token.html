<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm tra Token - Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-800 via-indigo-900 to-slate-900 min-h-screen text-white p-8">
    
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üîç Ki·ªÉm tra JWT Token</h1>
        
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6 border border-white/20">
            <h2 class="text-xl font-bold mb-4">Token hi·ªán t·∫°i trong localStorage:</h2>
            <div id="tokenInfo" class="space-y-4"></div>
        </div>

        <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
            <h2 class="text-xl font-bold mb-4">Token Payload (decoded):</h2>
            <pre id="tokenPayload" class="bg-black/30 p-4 rounded overflow-auto text-sm"></pre>
        </div>

        <div class="mt-6 flex gap-4">
            <button onclick="clearAndReload()" class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-semibold transition">
                üóëÔ∏è X√≥a Token & Reload
            </button>
            <button onclick="window.location.href='login.html'" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-semibold transition">
                ‚û°Ô∏è ƒêi ƒë·∫øn Trang Login
            </button>
        </div>
    </div>

    <script>
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        function checkToken() {
            const token = localStorage.getItem('token');
            const session = JSON.parse(localStorage.getItem('session_user') || 'null');
            
            const tokenInfoDiv = document.getElementById('tokenInfo');
            const tokenPayloadDiv = document.getElementById('tokenPayload');
            
            let html = '';
            
            if (!token) {
                html += '<p class="text-red-400 font-bold">‚ùå Kh√¥ng t√¨m th·∫•y token trong localStorage</p>';
                tokenInfoDiv.innerHTML = html;
                tokenPayloadDiv.textContent = 'No token found';
                return;
            }
            
            html += `<p class="text-green-400 font-bold">‚úÖ Token t·ªìn t·∫°i</p>`;
            html += `<p class="text-sm text-gray-300 break-all">Token: ${token.substring(0, 50)}...</p>`;
            
            const payload = parseJwt(token);
            
            if (payload) {
                html += '<div class="mt-4 space-y-2">';
                html += '<p class="font-bold text-yellow-300">üìã Th√¥ng tin trong Token:</p>';
                html += `<p>‚Ä¢ User ID: <span class="text-cyan-300">${payload.id || 'N/A'}</span></p>`;
                html += `<p>‚Ä¢ Username: <span class="text-cyan-300">${payload.username || 'N/A'}</span></p>`;
                html += `<p>‚Ä¢ Role: <span class="text-cyan-300">${payload.role || 'N/A'}</span></p>`;
                html += `<p class="font-bold ${payload.company_id ? 'text-green-400' : 'text-red-400'}">‚Ä¢ Company ID: <span class="text-cyan-300">${payload.company_id || '‚ùå KH√îNG C√ì (C·∫¶N LOGIN L·∫†I!)'}</span></p>`;
                html += `<p>‚Ä¢ Issued At: <span class="text-gray-400">${payload.iat ? new Date(payload.iat * 1000).toLocaleString('vi-VN') : 'N/A'}</span></p>`;
                html += `<p>‚Ä¢ Expires At: <span class="text-gray-400">${payload.exp ? new Date(payload.exp * 1000).toLocaleString('vi-VN') : 'N/A'}</span></p>`;
                html += '</div>';
                
                tokenPayloadDiv.textContent = JSON.stringify(payload, null, 2);
                
                if (!payload.company_id) {
                    html += `
                        <div class="mt-4 bg-red-600/20 border border-red-500 rounded p-4">
                            <p class="font-bold text-red-300">‚ö†Ô∏è C·∫¢NH B√ÅO:</p>
                            <p class="text-sm mt-2">Token c·ªßa b·∫°n KH√îNG c√≥ company_id. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√†:</p>
                            <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                                <li>B·∫°n ƒëang d√πng token c≈© (tr∆∞·ªõc khi c√≥ t√≠nh nƒÉng multi-tenancy)</li>
                                <li>Filtering theo c√¥ng ty S·∫º KH√îNG ho·∫°t ƒë·ªông</li>
                                <li>B·∫°n c√≥ th·ªÉ th·∫•y d·ªØ li·ªáu c·ªßa T·∫§T C·∫¢ c√¥ng ty</li>
                            </ul>
                            <p class="font-bold mt-3 text-yellow-300">‚úÖ GI·∫¢I PH√ÅP: ƒêƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i!</p>
                        </div>
                    `;
                }
            } else {
                html += '<p class="text-red-400 mt-4">‚ùå Kh√¥ng th·ªÉ decode token</p>';
                tokenPayloadDiv.textContent = 'Invalid token format';
            }
            
            if (session) {
                html += '<div class="mt-4 space-y-2">';
                html += '<p class="font-bold text-yellow-300">üìã Session User:</p>';
                html += `<pre class="text-sm text-gray-300">${JSON.stringify(session, null, 2)}</pre>`;
                html += '</div>';
            }
            
            tokenInfoDiv.innerHTML = html;
        }

        function clearAndReload() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a token v√† reload trang?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('session_user');
                alert('ƒê√£ x√≥a token! Trang s·∫Ω reload...');
                location.reload();
            }
        }

        // Run on load
        checkToken();
    </script>

</body>
</html>
