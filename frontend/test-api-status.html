<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîç Ki·ªÉm tra tr·∫°ng th√°i API v√† Database</h2>
        
        <!-- Auth Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>1. Tr·∫°ng th√°i Authentication</h5>
            </div>
            <div class="card-body">
                <div id="authStatus">ƒêang ki·ªÉm tra...</div>
                <button class="btn btn-primary mt-2" onclick="checkAuth()">Ki·ªÉm tra l·∫°i</button>
                <a href="index.html" class="btn btn-warning mt-2">ƒêi ƒëƒÉng nh·∫≠p</a>
            </div>
        </div>

        <!-- API Test -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>2. Test API Endpoint</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="testAPI()">Test GET /api/tests</button>
                <div id="apiResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Database Data -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>3. D·ªØ li·ªáu Database</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="checkDatabase()">Ki·ªÉm tra d·ªØ li·ªáu DB</button>
                <div id="dbResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Fix Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>4. Thao t√°c s·ª≠a l·ªói</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-danger" onclick="clearCache()">X√≥a Cache</button>
                <button class="btn btn-secondary" onclick="reloadPage()">Reload Exam Page</button>
                <a href="exam.html" class="btn btn-primary">ƒêi trang Exam</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const user = localStorage.getItem('session_user');
            
            const statusDiv = document.getElementById('authStatus');
            
            if (token) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ƒê√£ c√≥ JWT Token</strong><br>
                        Token: <code>${token.substring(0, 30)}...</code><br>
                        User: <code>${user || 'Kh√¥ng c√≥ user info'}</code>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Ch∆∞a c√≥ JWT Token</strong><br>
                        B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi g·ªçi API.
                    </div>
                `;
            }
        }

        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="spinner-border" role="status"></div> ƒêang test API...';

            try {
                console.log('Testing API...');
                const headers = getAuthHeaders();
                console.log('Headers:', headers);

                const response = await fetch(`${API_BASE_URL}/tests`, {
                    headers: headers
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API Response:', result);

                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ API ho·∫°t ƒë·ªông t·ªët</strong><br>
                        <strong>S·ªë ƒë·ªÅ thi t√¨m th·∫•y:</strong> ${tests.length}<br>
                        <strong>Raw Response:</strong>
                        <pre class="mt-2" style="max-height: 200px; overflow-y: auto;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                console.error('API Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå API Error</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <small>Ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt</small>
                    </div>
                `;
            }
        }

        async function checkDatabase() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.innerHTML = 'ƒêang ki·ªÉm tra database...';

            // First check if we have sample data
            const sampleTests = [
                { name: "Test JavaScript Basic", description: "Ki·ªÉm tra ki·∫øn th·ª©c JS c∆° b·∫£n" },
                { name: "Test Python Advanced", description: "B√†i test Python n√¢ng cao" },
                { name: "Test SQL Database", description: "Ki·ªÉm tra k·ªπ nƒÉng SQL" }
            ];

            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>üí° G·ª£i √Ω:</strong> N·∫øu database tr·ªëng, h√£y th√™m m·ªôt s·ªë ƒë·ªÅ thi m·∫´u:<br>
                    <ul class="mt-2 mb-0">
                        ${sampleTests.map(test => `<li>${test.name}: ${test.description}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('ƒê√£ x√≥a cache. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
            window.location.href = 'index.html';
        }

        function reloadPage() {
            window.location.href = 'exam.html';
        }

        // Auto check auth on load
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>