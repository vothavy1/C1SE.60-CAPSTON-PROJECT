<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ph√≤ng Thi Tr·ª±c Tuy·∫øn</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-blue-100 min-h-screen text-gray-800 font-sans">
  <script>
    // Guard: y√™u c·∫ßu ƒëƒÉng nh·∫≠p v√† ph·∫£i l√† CANDIDATE; n·∫øu l√† RECRUITER chuy·ªÉn qua trang recruiter
    (function guardRole() {
      try {
        // Check for authentication token
        const token = localStorage.getItem('token') || 
                     localStorage.getItem('auth_token') || 
                     localStorage.getItem('authToken');
        
        if (!token) {
          console.log('üîê No authentication token found, redirecting to login');
          location.replace('index.html');
          return;
        }
        
        // Validate token format
        try {
          const parts = token.split('.');
          if (parts.length !== 3) {
            console.error('‚ùå Invalid JWT token format');
            localStorage.clear();
            location.replace('index.html');
            return;
          }
          
          // Parse token payload to get user info
          const payload = JSON.parse(atob(parts[1]));
          console.log('üë§ Token payload:', { id: payload.id, role: payload.role, username: payload.username });
          
          // Check if token is expired
          if (payload.exp && Date.now() >= payload.exp * 1000) {
            console.error('‚è∞ Token has expired');
            localStorage.clear();
            location.replace('index.html');
            return;
          }
          
        } catch (tokenError) {
          console.error('‚ùå Token parsing error:', tokenError);
          localStorage.clear();
          location.replace('index.html');
          return;
        }
        
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        if (!session) {
          console.log('üìù No session data found, but token exists - continuing');
        } else {
          const role = String(session.role || '').toUpperCase();
          if (role === 'ADMIN') {
            console.log('üë®‚Äçüíº Admin detected, redirecting to admin dashboard');
            location.replace('admin-dashboard.html');
            return;
          }
          if (role === 'RECRUITER') {
            console.log('üë®‚Äçüíº Recruiter detected, redirecting to recruiter dashboard');
            location.replace('recruiter.html');
            return;
          }
          
          // Set header name if present
          setTimeout(() => {
            const nameEl = document.getElementById('userName');
            if (nameEl && session.name) {
              nameEl.textContent = `Xin ch√†o, ${session.name}!`;
            }
          }, 100);
        }
        
      } catch (error) {
        console.error('‚ùå Authentication guard error:', error);
        localStorage.clear();
        location.replace('index.html');
      }
    })();
  </script>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-10 border-b border-blue-200">
  <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-6">
    <!-- Logo / T√™n App -->
    <h1 class="text-3xl font-bold text-blue-600 tracking-wide">Tuy·ªÉn d·ª•ng</h1>

    <!-- Th√¥ng tin ng∆∞·ªùi d√πng v√† ƒëƒÉng xu·∫•t -->
    <div class="flex items-center gap-3">
      <span id="userName" class="font-medium text-gray-700">Xin ch√†o, h·ªçc vi√™n!</span>
      
      <button id="profileBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg transition shadow-md flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        H·ªì s∆°
      </button>
      
      <button id="logoutBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow-md">
        ƒêƒÉng xu·∫•t
      </button>
    </div>
  </div>
</header>

<script>
  // ƒêƒÉng xu·∫•t: xo√° token + session, quay v·ªÅ trang ƒëƒÉng nh·∫≠p
  document.getElementById("logoutBtn").addEventListener("click", () => {
    try {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('session_user');
    } catch(_) {}
    window.location.href = "index.html";
  });
</script>


  <!-- Main content -->
  <main class="max-w-5xl mx-auto mt-6 p-8 bg-white rounded-2xl shadow-xl border border-blue-200">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-semibold flex items-center gap-2 text-blue-700">
        üìù Danh s√°ch b√†i test tuy·ªÉn d·ª•ng
      </h3>
      <div class="flex items-center gap-4">
        
      </div>
    </div>



    <!-- Danh s√°ch b√†i thi -->
    <div id="examList" class="grid md:grid-cols-2 gap-6">
      <!-- Render JS -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center py-6 text-gray-600 mt-12 border-t border-blue-200 bg-white">
    ¬© 2025 <span class="text-blue-600 font-semibold">ExamPro</span>. All rights reserved.
  </footer>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6 rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold flex items-center gap-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            H·ªì S∆° ·ª®ng Vi√™n
          </h2>
          <button onclick="closeProfileModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div id="profileContent" class="space-y-4">
          <!-- Loading -->
          <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="text-gray-700 mt-2">ƒêang t·∫£i th√¥ng tin...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:5000/api';

    // Get auth headers with JWT token
    function getAuthHeaders() {
      // Try multiple possible token storage keys
      const token = localStorage.getItem('token') || 
                   localStorage.getItem('auth_token') || 
                   localStorage.getItem('authToken');
      
      if (!token) {
        console.warn('‚ö†Ô∏è No authentication token found');
        return {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        };
      }
      
      // Validate token format
      try {
        const parts = token.split('.');
        if (parts.length !== 3) {
          console.error('‚ùå Invalid JWT token format');
          localStorage.removeItem('token');
          localStorage.removeItem('auth_token');
          localStorage.removeItem('authToken');
          return {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          };
        }
      } catch (error) {
        console.error('‚ùå Token validation error:', error);
        return {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        };
      }
      
      return {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0',
        'Authorization': `Bearer ${token}`
      };
    }

    // Show loading spinner
    function showLoading() {
      console.log('showLoading called');
      const list = document.getElementById("examList");
      list.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="text-gray-700 mt-2">ƒêang t·∫£i danh s√°ch ƒë·ªÅ thi...</p>
        </div>
      `;
    }

    // Show error message with optional retry button
    function showError(message, showRetry = false) {
      const list = document.getElementById("examList");
      list.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="bg-red-50 border border-red-300 rounded-lg p-6">
            <h4 class="text-red-600 text-lg font-semibold mb-2">‚ö†Ô∏è C√≥ l·ªói x·∫£y ra</h4>
            <p class="text-red-700 mb-4">${message}</p>
            ${showRetry ? `
              <button onclick="loadExams()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow-md">
                üîÑ Th·ª≠ l·∫°i
              </button>
            ` : ''}
            <button onclick="loadExams()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition shadow-md">
              üîÑ T·∫£i l·∫°i
            </button>
            <button onclick="testConnection()" class="mt-4 ml-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition shadow-md">
              üîß Test k·∫øt n·ªëi
            </button>
          </div>
        </div>
      `;
    }

    // Fetch exams from API
    async function loadExams() {
      console.log('üîÑ loadExams function called');
      showLoading();
      
      try {
        // Check authentication first
        const headers = getAuthHeaders();
        if (!headers.Authorization) {
          console.error('‚ùå No valid authentication token, redirecting to login');
          localStorage.clear();
          window.location.href = 'index.html';
          return;
        }
        
        console.log('üîó Making API request to:', `${API_BASE_URL}/tests`);
        const response = await fetch(`${API_BASE_URL}/tests`, {
          method: 'GET',
          headers: headers,
          cache: 'no-cache'
        });

        console.log('üì° Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          if (response.status === 401) {
            console.error('‚ùå 401 Unauthorized - Token expired or invalid');
            localStorage.clear();
            alert('‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
            window.location.href = 'index.html';
            return;
          }
          if (response.status === 403) {
            console.error('‚ùå 403 Forbidden - Access denied');
            alert('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n!');
            return;
          }
          if (response.status === 0 || response.status >= 500) {
            throw new Error('L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i sau.');
          }
          
          const errorText = await response.text();
          throw new Error(`L·ªói ${response.status}: ${errorText || response.statusText}`);
        }

        const result = await response.json();
        console.log('API Response:', result);
        console.log('Response keys:', Object.keys(result));
        
        // Handle different response structures
        let tests = [];
        if (result.success && result.data && result.data.tests) {
          tests = result.data.tests;
          console.log('Using result.data.tests path');
        } else if (Array.isArray(result.data)) {
          tests = result.data;
          console.log('Using result.data path');
        } else if (Array.isArray(result)) {
          tests = result;
          console.log('Using result path');
        } else {
          console.log('Unknown response structure:', result);
        }

        console.log('Total tests from database:', tests.length);
        console.log('All tests details:', tests.map(t => `ID:${t.test_id} "${t.test_name}" Status:${t.status}`));
        
        // Show all tests for students (both ACTIVE and DRAFT)
        // Students can see all available tests
        const activeTests = tests.filter(test => test.status === 'ACTIVE');
        console.log('ACTIVE tests for students:', activeTests.length);
        console.log('ACTIVE tests:', activeTests.map(t => `ID:${t.test_id} "${t.test_name}"`));
        
        if (tests.length > 0) {
          console.log('Sample test from database:', tests[0]);
        }

        renderExams(tests);

      } catch (error) {
        console.error('‚ùå Error loading exams:', error);
        
        // Check if it's a network error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          showError('‚ùå L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.', true);
        } else if (error.message.includes('ERR_CONNECTION_RESET')) {
          showError('‚ùå Server ƒëang b·∫£o tr√¨. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.', true);
        } else {
          showError(`‚ùå ${error.message}`, true);
        }
      }
    }

    // Render exams list
    function renderExams(tests) {
      const list = document.getElementById("examList");
      
      if (!Array.isArray(tests) || tests.length === 0) {
        list.innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-6">
              <h4 class="text-yellow-700 text-lg font-semibold mb-2">Ch∆∞a c√≥ ƒë·ªÅ thi</h4>
              <p class="text-yellow-600">Hi·ªán t·∫°i ch∆∞a c√≥ ƒë·ªÅ thi n√†o kh·∫£ d·ª•ng.</p>
            </div>
          </div>
        `;
        return;
      }

      console.log('Rendering tests. Total received:', tests.length);

      // Clear loading and render tests
      list.innerHTML = '';
      
      // Sort tests: ACTIVE first, then by created_at desc
      const sortedTests = [...tests].sort((a, b) => {
        // ACTIVE tests first
        if (a.status === 'ACTIVE' && b.status !== 'ACTIVE') return -1;
        if (a.status !== 'ACTIVE' && b.status === 'ACTIVE') return 1;
        
        // Then by creation date (newest first)
        const dateA = new Date(a.created_at || 0);
        const dateB = new Date(b.created_at || 0);
        return dateB - dateA;
      });
      
      console.log('Sorted tests:', sortedTests.map(t => `${t.test_name}(${t.status})`));
      
      sortedTests.forEach(test => {
        const div = document.createElement("div");
        div.className = "p-6 rounded-xl bg-white border border-blue-200 hover:shadow-2xl hover:scale-[1.02] transition";
        
        // Format test data
        const testName = test.test_name || test.name || 'ƒê·ªÅ thi kh√¥ng c√≥ t√™n';
        const testDesc = test.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
        const testId = test.test_id || test.id;
        const duration = test.duration_minutes || test.duration || 60;
        const difficulty = test.difficulty_level || test.difficulty || 'Kh√¥ng x√°c ƒë·ªãnh';
        
        // Check both status and is_active fields
        const status = test.status || (test.is_active ? 'ACTIVE' : 'INACTIVE');
        const isActive = test.is_active !== false && (test.status === 'ACTIVE' || test.status === 'active' || !test.status);

        console.log(`Test ${testName}: status="${test.status}", is_active=${test.is_active}, final_status="${status}", isActive=${isActive}`);

        // Only show ACTIVE tests for students
        if (!isActive) return;

        div.innerHTML = `
          <div class="mb-3">
            <h4 class="text-lg font-semibold text-blue-700 mb-2">${testName}</h4>
            <p class="text-gray-600 text-sm mb-2">${testDesc}</p>
            <div class="flex flex-wrap gap-2 text-xs">
              <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">‚è±Ô∏è ${duration} ph√∫t</span>
              <span class="bg-cyan-100 text-cyan-700 px-2 py-1 rounded">üìä ${difficulty}</span>
              <span class="bg-${status === 'ACTIVE' ? 'green' : 'orange'}-100 text-${status === 'ACTIVE' ? 'green' : 'orange'}-700 px-2 py-1 rounded">
                üìã ${status} (ID: ${testId})
              </span>
            </div>
          </div>
          <button
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition w-full shadow-md"
            onclick="startTest('${testId}', '${testName}')"
          >
            üöÄ L√†m b√†i thi
          </button>
        `;
        
        list.appendChild(div);
      });
    }

    // Start test function
    async function startTest(testId, testName) {
      if (!testId) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi');
        return;
      }
      
      // Confirm before starting test
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu l√†m ƒë·ªÅ thi "${testName}"?\n\nL∆∞u √Ω: Sau khi b·∫Øt ƒë·∫ßu, b·∫°n kh√¥ng th·ªÉ tho√°t gi·ªØa ch·ª´ng.`)) {
        return;
      }

      try {
        // Get current user info - CH·ªà check userId (chu·∫©n h√≥a)
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        const authToken = localStorage.getItem('auth_token');
        
        if (!session || !session.userId || !authToken) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
          localStorage.clear(); // Clear all data
          window.location.href = 'index.html';
          return;
        }
        
        console.log('‚úÖ Session valid:', session.userId, session.role);

        // Check if user has a candidate profile - D√πng userId
        let candidateId;
        const candidateResponse = await fetch(`${API_BASE_URL}/candidates/by-user/${session.userId}`, {
          headers: getAuthHeaders()
        });

        if (candidateResponse.ok) {
          const candidateData = await candidateResponse.json();
          candidateId = candidateData.data?.candidate_id;
          console.log('‚úÖ Found existing candidate:', candidateId);
        } else if (candidateResponse.status === 404) {
          // Candidate profile not found, create one automatically
          console.log('üìù Creating candidate profile for user:', session.userId);
          
          const createCandidateResponse = await fetch(`${API_BASE_URL}/candidates/self-register`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
              user_id: session.userId,
              first_name: session.fullName || session.username || 'User',
              last_name: '-',
              email: session.email || '',
              status: 'NEW'
            })
          });

          if (createCandidateResponse.ok) {
            const newCandidate = await createCandidateResponse.json();
            candidateId = newCandidate.data?.candidate_id;
            console.log('‚úÖ Created candidate profile:', candidateId);
          } else {
            // Log chi ti·∫øt l·ªói
            const errorData = await createCandidateResponse.json().catch(() => ({}));
            console.error('‚ùå Failed to create candidate:', createCandidateResponse.status, errorData);
            
            // N·∫øu l·ªói l√† "already exists", th·ª≠ l·∫•y l·∫°i
            if (errorData.message?.includes('already has a candidate profile')) {
              console.log('üîÑ Candidate exists, fetching again...');
              const retryResponse = await fetch(`${API_BASE_URL}/candidates/by-user/${session.userId}`, {
                headers: getAuthHeaders()
              });
              if (retryResponse.ok) {
                const retryData = await retryResponse.json();
                candidateId = retryData.data?.candidate_id;
                console.log('‚úÖ Got candidate on retry:', candidateId);
              }
            }
          }
        } else {
          // Log l·ªói API kh√°c
          console.error('‚ùå Error fetching candidate:', candidateResponse.status);
        }

        if (!candidateId) {
          alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o h·ªì s∆° ·ª©ng vi√™n. Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i.');
          btn.disabled = false;
          btn.innerHTML = 'üöÄ L√†m b√†i thi';
          return;
        }

        // Create candidate_test entry using self-assign route
        console.log('üéØ Self-assigning test:', testId, 'for candidate:', candidateId);
        const assignResponse = await fetch(`${API_BASE_URL}/candidate-tests/self-assign`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            candidate_id: candidateId,
            test_id: testId
          })
        });

        if (!assignResponse.ok) {
          const errorData = await assignResponse.json().catch(() => ({}));
          console.error('‚ùå Failed to assign test:', assignResponse.status, errorData);
          
          // If test already assigned, the API returns 200 with existing test data
          // So if we get here, it's a real error
          throw new Error(errorData.message || 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o b√†i thi');
        }

        const assignResult = await assignResponse.json();
        const candidateTestId = assignResult.data?.candidate_test_id;

        if (!candidateTestId) {
          throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ID b√†i thi');
        }

        // Redirect to test page with both IDs
        window.location.href = `test.html?testId=${testId}&candidateTestId=${candidateTestId}`;

      } catch (error) {
        console.error('Error starting test:', error);
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
        const btn = event.target;
        btn.disabled = false;
        btn.innerHTML = 'üöÄ L√†m b√†i thi';
      }
    }

    // Load exams when page loads
    // Test connection function for debugging
    async function testConnection() {
      console.log('üîß Testing connection...');
      const list = document.getElementById("examList");
      list.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="bg-blue-500/20 border border-blue-400 rounded-lg p-6">
            <h4 class="text-blue-200 text-lg font-semibold mb-2">üîß ƒêang test k·∫øt n·ªëi...</h4>
            <p class="text-blue-300">Ki·ªÉm tra k·∫øt n·ªëi ƒë·∫øn server...</p>
          </div>
        </div>
      `;
      
      try {
        // Test basic connection without auth
        console.log('Testing basic server connection...');
        const healthResponse = await fetch(`${API_BASE_URL}/health`, {
          method: 'GET',
          cache: 'no-cache'
        });
        
        console.log('Health check response:', healthResponse.status);
        
        // Test with auth
        console.log('Testing authenticated request...');
        const headers = getAuthHeaders();
        console.log('Auth headers:', headers);
        
        const testResponse = await fetch(`${API_BASE_URL}/tests`, {
          method: 'GET',
          headers: headers,
          cache: 'no-cache'
        });
        
        console.log('Tests API response:', testResponse.status);
        
        if (testResponse.ok) {
          const data = await testResponse.json();
          console.log('Response data:', data);
          
          list.innerHTML = `
            <div class="col-span-full text-center py-8">
              <div class="bg-green-500/20 border border-green-400 rounded-lg p-6">
                <h4 class="text-green-200 text-lg font-semibold mb-2">‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!</h4>
                <p class="text-green-300">Server: ${healthResponse.ok ? 'Online' : 'Offline'}</p>
                <p class="text-green-300">API: ${testResponse.status} ${testResponse.statusText}</p>
                <p class="text-green-300">Tests found: ${data.data?.tests?.length || data.data?.length || 'N/A'}</p>
                <button onclick="loadExams()" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                  T·∫£i danh s√°ch ƒë·ªÅ thi
                </button>
              </div>
            </div>
          `;
        } else {
          throw new Error(`API Error: ${testResponse.status} ${testResponse.statusText}`);
        }
        
      } catch (error) {
        console.error('Connection test failed:', error);
        list.innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="bg-red-500/20 border border-red-400 rounded-lg p-6">
              <h4 class="text-red-200 text-lg font-semibold mb-2">‚ùå Test k·∫øt n·ªëi th·∫•t b·∫°i</h4>
              <p class="text-red-300">Error: ${error.message}</p>
              <p class="text-red-300 text-sm mt-2">Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt</p>
              <button onclick="testConnection()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                Th·ª≠ l·∫°i
              </button>
            </div>
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, calling loadExams...');
      loadExams();
    });

    // Profile Modal Functions
    function openProfileModal() {
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('profileModal').classList.add('flex');
      loadCandidateProfile();
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.add('hidden');
      document.getElementById('profileModal').classList.remove('flex');
    }

    async function loadCandidateProfile() {
      const profileContent = document.getElementById('profileContent');
      
      try {
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        if (!session || !session.userId) {
          profileContent.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-600">Kh√¥ng t√¨m th·∫•y th√¥ng tin phi√™n ƒëƒÉng nh·∫≠p</p>
            </div>
          `;
          return;
        }

        // Fetch candidate info
        const candidateResponse = await fetch(`${API_BASE_URL}/candidates/by-user/${session.userId}`, {
          headers: getAuthHeaders()
        });

        if (!candidateResponse.ok) {
          throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin ·ª©ng vi√™n');
        }

        const candidateData = await candidateResponse.json();
        const candidate = candidateData.data;

        // Fetch test results
        const testsResponse = await fetch(`${API_BASE_URL}/candidate-tests/my-tests`, {
          headers: getAuthHeaders()
        });

        let completedTests = [];
        let totalScore = 0;
        let passedTests = 0;

        if (testsResponse.ok) {
          const testsData = await testsResponse.json();
          completedTests = (testsData.data || []).filter(t => t.status === 'COMPLETED');
          
          completedTests.forEach(test => {
            const score = test.manual_score || test.score || 0;
            totalScore += score;
            if (score >= 50) passedTests++;
          });
        }

        const avgScore = completedTests.length > 0 ? (totalScore / completedTests.length).toFixed(1) : 0;

        // Render profile
        profileContent.innerHTML = `
          <div class="space-y-6">
            <!-- Th√¥ng tin c√° nh√¢n -->
            <div class="bg-blue-50 rounded-lg p-6">
              <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Th√¥ng Tin C√° Nh√¢n
              </h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-medium text-gray-600">H·ªç v√† t√™n</label>
                  <p class="text-gray-800 font-semibold">${candidate.first_name || ''} ${candidate.last_name || ''}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Email</label>
                  <p class="text-gray-800 font-semibold">${candidate.email || 'N/A'}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">S·ªë ƒëi·ªán tho·∫°i</label>
                  <p class="text-gray-800">${candidate.phone || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">V·ªã tr√≠ ·ª©ng tuy·ªÉn</label>
                  <p class="text-gray-800">${candidate.position || 'Ch∆∞a x√°c ƒë·ªãnh'}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Kinh nghi·ªám</label>
                  <p class="text-gray-800">${candidate.experience_years || candidate.years_of_experience || 0} nƒÉm</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Tr·∫°ng th√°i</label>
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${
                    candidate.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                  }">
                    ${candidate.status || 'N/A'}
                  </span>
                </div>
              </div>
            </div>

            <!-- Th·ªëng k√™ b√†i thi -->
            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-lg p-6">
              <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Th·ªëng K√™ B√†i Thi
              </h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <div class="text-3xl font-bold text-blue-600">${completedTests.length}</div>
                  <div class="text-sm text-gray-600">B√†i ƒë√£ l√†m</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-green-600">${passedTests}</div>
                  <div class="text-sm text-gray-600">ƒê·∫°t y√™u c·∫ßu</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-red-600">${completedTests.length - passedTests}</div>
                  <div class="text-sm text-gray-600">Ch∆∞a ƒë·∫°t</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold text-purple-600">${avgScore}</div>
                  <div class="text-sm text-gray-600">ƒêi·ªÉm TB</div>
                </div>
              </div>
            </div>

            <!-- L·ªãch s·ª≠ b√†i thi -->
            ${completedTests.length > 0 ? `
              <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <h3 class="text-lg font-bold text-blue-800 p-4 bg-gray-50 border-b flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  L·ªãch S·ª≠ B√†i Thi (${completedTests.length} b√†i)
                </h3>
                <div class="max-h-64 overflow-y-auto">
                  ${completedTests.map(test => {
                    const score = test.manual_score || test.score || 0;
                    const isPassed = score >= 50;
                    return `
                      <div class="p-4 border-b hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start">
                          <div class="flex-1">
                            <p class="font-semibold text-gray-800">${test.Test?.test_name || 'B√†i thi'}</p>
                            <p class="text-sm text-gray-600">${new Date(test.end_time).toLocaleString('vi-VN')}</p>
                          </div>
                          <div class="text-right">
                            <div class="text-2xl font-bold ${isPassed ? 'text-green-600' : 'text-red-600'}">
                              ${score}
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${isPassed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                              ${isPassed ? '‚úì ƒê·∫°t' : '‚úó Ch∆∞a ƒë·∫°t'}
                            </span>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : `
              <div class="text-center py-8 bg-gray-50 rounded-lg">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-600">B·∫°n ch∆∞a ho√†n th√†nh b√†i thi n√†o</p>
              </div>
            `}
          </div>
        `;

      } catch (error) {
        console.error('Error loading profile:', error);
        profileContent.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-red-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-red-600 font-semibold">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin</p>
            <p class="text-gray-600 text-sm mt-2">${error.message}</p>
            <button onclick="loadCandidateProfile()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
              Th·ª≠ l·∫°i
            </button>
          </div>
        `;
      }
    }

    // Profile button click handler
    document.getElementById('profileBtn').addEventListener('click', openProfileModal);

    // Close modal when clicking outside
    document.getElementById('profileModal').addEventListener('click', function(e) {
      if (e.target.id === 'profileModal') {
        closeProfileModal();
      }
    });
  </script>
</body>
</html>
