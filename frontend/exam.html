<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ph√≤ng Thi Tr·ª±c Tuy·∫øn</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-indigo-800 min-h-screen text-white font-sans">
  <script>
    // Guard: y√™u c·∫ßu ƒëƒÉng nh·∫≠p v√† ph·∫£i l√† CANDIDATE; n·∫øu l√† RECRUITER chuy·ªÉn qua trang recruiter
    (function guardRole() {
      try {
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        if (!session) {
          location.replace('index.html');
          return;
        }
        const role = String(session.role || '').toUpperCase();
        if (role === 'RECRUITER') {
          location.replace('recruiter.html');
          return;
        }
        // Set header name if present
        const nameEl = document.getElementById('userName');
        if (nameEl && session.name) nameEl.textContent = `Xin ch√†o, ${session.name}!`;
      } catch (_) {
        location.replace('index.html');
      }
    })();
  </script>

  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-10 border-b border-purple-400/30">
  <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-6">
    <!-- Logo / T√™n App -->
    <h1 class="text-3xl font-bold text-white tracking-wide">Tuy·ªÉn d·ª•ng</h1>

    <!-- Th√¥ng tin ng∆∞·ªùi d√πng v√† ƒëƒÉng xu·∫•t -->
    <div class="flex items-center gap-4">
      <span id="userName" class="font-medium text-purple-200">Xin ch√†o, h·ªçc vi√™n!</span>
      
      <button id="logoutBtn" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
        ƒêƒÉng xu·∫•t
      </button>
    </div>
  </div>
</header>

<script>
  // ƒêƒÉng xu·∫•t: xo√° token + session, quay v·ªÅ trang ƒëƒÉng nh·∫≠p
  document.getElementById("logoutBtn").addEventListener("click", () => {
    try {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('session_user');
    } catch(_) {}
    window.location.href = "index.html";
  });
</script>


  <!-- Hero -->
  <section class="text-center py-12 bg-gradient-to-r from-indigo-600 to-purple-700 shadow-lg">
    <h2 class="text-4xl font-semibold mb-3">H·ªá th·ªëng thi tr·ª±c tuy·∫øn th√¥ng minh</h2>
    <p class="text-purple-100 mb-6 text-lg">Th·ª±c hi·ªán b√†i thi c√≥ gi√°m s√°t khu√¥n m·∫∑t b·∫±ng AI ‚Äì an to√†n, ti·ªán l·ª£i v√† chuy√™n nghi·ªáp</p>

    <button
      id="startExamBtn"
      class="bg-gradient-to-r from-yellow-400 to-amber-300 text-indigo-900 px-8 py-3 rounded-lg font-bold hover:scale-105 hover:shadow-lg transition"
      onclick="scrollToExamList()"
    >
      üöÄ Xem danh s√°ch ƒë·ªÅ thi
    </button>
  </section>

  <!-- Main content -->
  <main class="max-w-5xl mx-auto mt-10 p-8 bg-white/10 rounded-2xl shadow-xl border border-purple-300/30 backdrop-blur-md">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-semibold flex items-center gap-2 text-white">
        üìù Danh s√°ch b√†i test tuy·ªÉn d·ª•ng
      </h3>
      <div class="flex items-center gap-4">
        
      </div>
    </div>



    <!-- Danh s√°ch b√†i thi -->
    <div id="examList" class="grid md:grid-cols-2 gap-6">
      <!-- Render JS -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center py-6 text-purple-200 mt-12 border-t border-purple-500/30">
    ¬© 2025 <span class="text-white font-semibold">ExamPro</span>. All rights reserved.
  </footer>

  <!-- JS -->
  <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:5000/api';

    // Get auth headers with JWT token
    function getAuthHeaders() {
      const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      };
    }

    // Show loading spinner
    function showLoading() {
      console.log('showLoading called');
      const list = document.getElementById("examList");
      list.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
          <p class="text-white mt-2">ƒêang t·∫£i danh s√°ch ƒë·ªÅ thi...</p>
        </div>
      `;
    }

    // Show error message
    function showError(message) {
      const list = document.getElementById("examList");
      list.innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="bg-red-500/20 border border-red-400 rounded-lg p-6">
            <h4 class="text-red-200 text-lg font-semibold mb-2">L·ªói t·∫£i d·ªØ li·ªáu</h4>
            <p class="text-red-300">${message}</p>
            <button onclick="loadExams()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
              Th·ª≠ l·∫°i
            </button>
          </div>
        </div>
      `;
    }

    // Fetch exams from API
    async function loadExams() {
      console.log('loadExams function called');
      showLoading();
      
      try {
        const response = await fetch(`${API_BASE_URL}/tests`, {
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          if (response.status === 401) {
            // Token expired or invalid, redirect to login
            localStorage.removeItem('auth_token');
            localStorage.removeItem('session_user');
            window.location.href = 'index.html';
            return;
          }
          throw new Error(`L·ªói ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('API Response:', result);
        console.log('Response keys:', Object.keys(result));
        
        // Handle different response structures
        let tests = [];
        if (result.success && result.data && result.data.tests) {
          tests = result.data.tests;
          console.log('Using result.data.tests path');
        } else if (Array.isArray(result.data)) {
          tests = result.data;
          console.log('Using result.data path');
        } else if (Array.isArray(result)) {
          tests = result;
          console.log('Using result path');
        } else {
          console.log('Unknown response structure:', result);
        }

        console.log('Total tests from database:', tests.length);
        console.log('All tests details:', tests.map(t => `ID:${t.test_id} "${t.test_name}" Status:${t.status}`));
        
        // Show all tests for students (both ACTIVE and DRAFT)
        // Students can see all available tests
        const activeTests = tests.filter(test => test.status === 'ACTIVE');
        console.log('ACTIVE tests for students:', activeTests.length);
        console.log('ACTIVE tests:', activeTests.map(t => `ID:${t.test_id} "${t.test_name}"`));
        
        if (tests.length > 0) {
          console.log('Sample test from database:', tests[0]);
        }

        renderExams(tests);

      } catch (error) {
        console.error('Error loading exams:', error);
        showError(error.message);
      }
    }

    // Render exams list
    function renderExams(tests) {
      const list = document.getElementById("examList");
      
      if (!Array.isArray(tests) || tests.length === 0) {
        list.innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="bg-yellow-500/20 border border-yellow-400 rounded-lg p-6">
              <h4 class="text-yellow-200 text-lg font-semibold mb-2">Ch∆∞a c√≥ ƒë·ªÅ thi</h4>
              <p class="text-yellow-300">Hi·ªán t·∫°i ch∆∞a c√≥ ƒë·ªÅ thi n√†o kh·∫£ d·ª•ng.</p>
            </div>
          </div>
        `;
        return;
      }

      console.log('Rendering tests. Total received:', tests.length);

      // Clear loading and render tests
      list.innerHTML = '';
      
      // Sort tests: ACTIVE first, then by created_at desc
      const sortedTests = [...tests].sort((a, b) => {
        // ACTIVE tests first
        if (a.status === 'ACTIVE' && b.status !== 'ACTIVE') return -1;
        if (a.status !== 'ACTIVE' && b.status === 'ACTIVE') return 1;
        
        // Then by creation date (newest first)
        const dateA = new Date(a.created_at || 0);
        const dateB = new Date(b.created_at || 0);
        return dateB - dateA;
      });
      
      console.log('Sorted tests:', sortedTests.map(t => `${t.test_name}(${t.status})`));
      
      sortedTests.forEach(test => {
        const div = document.createElement("div");
        div.className = "p-6 rounded-xl bg-gradient-to-br from-purple-800/40 to-indigo-800/40 border border-purple-400/30 hover:shadow-2xl hover:scale-[1.02] transition";
        
        // Format test data
        const testName = test.test_name || test.name || 'ƒê·ªÅ thi kh√¥ng c√≥ t√™n';
        const testDesc = test.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
        const testId = test.test_id || test.id;
        const duration = test.duration_minutes || test.duration || 60;
        const difficulty = test.difficulty_level || test.difficulty || 'Kh√¥ng x√°c ƒë·ªãnh';
        
        // Check both status and is_active fields
        const status = test.status || (test.is_active ? 'ACTIVE' : 'INACTIVE');
        const isActive = test.is_active !== false && (test.status === 'ACTIVE' || test.status === 'active' || !test.status);

        console.log(`Test ${testName}: status="${test.status}", is_active=${test.is_active}, final_status="${status}", isActive=${isActive}`);

        // Only show ACTIVE tests for students
        if (!isActive) return;

        div.innerHTML = `
          <div class="mb-3">
            <h4 class="text-lg font-semibold text-white mb-2">${testName}</h4>
            <p class="text-purple-200 text-sm mb-2">${testDesc}</p>
            <div class="flex flex-wrap gap-2 text-xs">
              <span class="bg-blue-500/30 text-blue-200 px-2 py-1 rounded">‚è±Ô∏è ${duration} ph√∫t</span>
              <span class="bg-purple-500/30 text-purple-200 px-2 py-1 rounded">üìä ${difficulty}</span>
              <span class="bg-${status === 'ACTIVE' ? 'green' : 'orange'}-500/30 text-${status === 'ACTIVE' ? 'green' : 'orange'}-200 px-2 py-1 rounded">
                üìã ${status} (ID: ${testId})
              </span>
            </div>
          </div>
          <button
            class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition w-full"
            onclick="startTest('${testId}', '${testName}')"
          >
            üöÄ L√†m b√†i thi
          </button>
        `;
        
        list.appendChild(div);
      });
    }

    // Start test function
    async function startTest(testId, testName) {
      if (!testId) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y ID ƒë·ªÅ thi');
        return;
      }
      
      // Confirm before starting test
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu l√†m ƒë·ªÅ thi "${testName}"?\n\nL∆∞u √Ω: Sau khi b·∫Øt ƒë·∫ßu, b·∫°n kh√¥ng th·ªÉ tho√°t gi·ªØa ch·ª´ng.`)) {
        return;
      }

      try {
        // Get current user info - CH·ªà check userId (chu·∫©n h√≥a)
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        const authToken = localStorage.getItem('auth_token');
        
        if (!session || !session.userId || !authToken) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
          localStorage.clear(); // Clear all data
          window.location.href = 'index.html';
          return;
        }
        
        console.log('‚úÖ Session valid:', session.userId, session.role);

        // Check if user has a candidate profile - D√πng userId
        let candidateId;
        const candidateResponse = await fetch(`${API_BASE_URL}/candidates/by-user/${session.userId}`, {
          headers: getAuthHeaders()
        });

        if (candidateResponse.ok) {
          const candidateData = await candidateResponse.json();
          candidateId = candidateData.data?.candidate_id;
          console.log('‚úÖ Found existing candidate:', candidateId);
        } else if (candidateResponse.status === 404) {
          // Candidate profile not found, create one automatically
          console.log('üìù Creating candidate profile for user:', session.userId);
          
          const createCandidateResponse = await fetch(`${API_BASE_URL}/candidates/self-register`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
              user_id: session.userId,
              first_name: session.fullName || session.username || 'User',
              last_name: '-',
              email: session.email || '',
              status: 'NEW'
            })
          });

          if (createCandidateResponse.ok) {
            const newCandidate = await createCandidateResponse.json();
            candidateId = newCandidate.data?.candidate_id;
            console.log('‚úÖ Created candidate profile:', candidateId);
          } else {
            // Log chi ti·∫øt l·ªói
            const errorData = await createCandidateResponse.json().catch(() => ({}));
            console.error('‚ùå Failed to create candidate:', createCandidateResponse.status, errorData);
            
            // N·∫øu l·ªói l√† "already exists", th·ª≠ l·∫•y l·∫°i
            if (errorData.message?.includes('already has a candidate profile')) {
              console.log('üîÑ Candidate exists, fetching again...');
              const retryResponse = await fetch(`${API_BASE_URL}/candidates/by-user/${session.userId}`, {
                headers: getAuthHeaders()
              });
              if (retryResponse.ok) {
                const retryData = await retryResponse.json();
                candidateId = retryData.data?.candidate_id;
                console.log('‚úÖ Got candidate on retry:', candidateId);
              }
            }
          }
        } else {
          // Log l·ªói API kh√°c
          console.error('‚ùå Error fetching candidate:', candidateResponse.status);
        }

        if (!candidateId) {
          alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o h·ªì s∆° ·ª©ng vi√™n. Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i.');
          btn.disabled = false;
          btn.innerHTML = 'üöÄ L√†m b√†i thi';
          return;
        }

        // Create candidate_test entry using self-assign route
        console.log('üéØ Self-assigning test:', testId, 'for candidate:', candidateId);
        const assignResponse = await fetch(`${API_BASE_URL}/candidate-tests/self-assign`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({
            candidate_id: candidateId,
            test_id: testId
          })
        });

        if (!assignResponse.ok) {
          const errorData = await assignResponse.json().catch(() => ({}));
          console.error('‚ùå Failed to assign test:', assignResponse.status, errorData);
          
          // If test already assigned, the API returns 200 with existing test data
          // So if we get here, it's a real error
          throw new Error(errorData.message || 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o b√†i thi');
        }

        const assignResult = await assignResponse.json();
        const candidateTestId = assignResult.data?.candidate_test_id;

        if (!candidateTestId) {
          throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ID b√†i thi');
        }

        // Redirect to test page with both IDs
        window.location.href = `test.html?testId=${testId}&candidateTestId=${candidateTestId}`;

      } catch (error) {
        console.error('Error starting test:', error);
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
        const btn = event.target;
        btn.disabled = false;
        btn.innerHTML = 'üöÄ L√†m b√†i thi';
      }
    }

    // Scroll to exam list
    function scrollToExamList() {
      document.getElementById('examList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }



    // Load exams when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, calling loadExams...');
      loadExams();
    });
  </script>
</body>
</html>
