<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Full Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîÑ Test Full Login Flow</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>1. Login Test</h5>
                    </div>
                    <div class="card-body">
                        <input type="email" id="email" class="form-control mb-2" placeholder="Email" value="havy@test.com">
                        <input type="password" id="password" class="form-control mb-2" placeholder="Password" value="123456">
                        <button class="btn btn-primary" onclick="testLogin()">Test Login</button>
                        <div id="loginResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>2. API Test (After Login)</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testAPIWithAuth()">Test /api/tests</button>
                        <div id="apiResult" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>3. Render Tests (Like exam.html)</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-warning" onclick="renderLikeExam()">Render Tests</button>
                <div id="renderResult" class="mt-3"></div>
            </div>
        </div>

        <div class="mt-3">
            <a href="exam.html" class="btn btn-primary">Go to Exam Page</a>
            <a href="index.html" class="btn btn-secondary">Go to Login Page</a>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        async function testLogin() {
            const loginResult = document.getElementById('loginResult');
            loginResult.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Logging in...';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status}`);
                }

                const result = await response.json();
                console.log('Login result:', result);

                if (result.success && result.data.token) {
                    // Save token and user info
                    localStorage.setItem('auth_token', result.data.token);
                    localStorage.setItem('session_user', JSON.stringify(result.data.user));

                    loginResult.innerHTML = `
                        <div class="alert alert-success p-2">
                            ‚úÖ Login Success<br>
                            <small>User: ${result.data.user.name || result.data.user.email}</small><br>
                            <small>Role: ${result.data.user.role}</small>
                        </div>
                    `;
                } else {
                    throw new Error('Invalid login response');
                }

            } catch (error) {
                console.error('Login error:', error);
                loginResult.innerHTML = `
                    <div class="alert alert-danger p-2">
                        ‚ùå Login Failed<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        async function testAPIWithAuth() {
            const apiResult = document.getElementById('apiResult');
            apiResult.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing API...';

            try {
                const headers = getAuthHeaders();
                console.log('API Headers:', headers);

                const response = await fetch(`${API_BASE_URL}/tests`, { headers });
                console.log('API Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`API failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API Result:', result);

                // Parse like exam.html
                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                apiResult.innerHTML = `
                    <div class="alert alert-success p-2">
                        ‚úÖ API Success<br>
                        <small>Found: ${tests.length} tests</small>
                    </div>
                `;

            } catch (error) {
                console.error('API error:', error);
                apiResult.innerHTML = `
                    <div class="alert alert-danger p-2">
                        ‚ùå API Failed<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        async function renderLikeExam() {
            const renderResult = document.getElementById('renderResult');
            renderResult.innerHTML = '<div class="spinner-border"></div> Rendering...';

            try {
                const headers = getAuthHeaders();
                const response = await fetch(`${API_BASE_URL}/tests`, { headers });

                if (!response.ok) {
                    throw new Error(`API failed: ${response.status}`);
                }

                const result = await response.json();
                console.log('Render API Result:', result);

                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                if (!tests.length) {
                    renderResult.innerHTML = `
                        <div class="alert alert-warning">
                            üìù No tests found in database
                        </div>
                    `;
                    return;
                }

                // Render tests like exam.html
                let html = '<div class="row">';
                tests.slice(0, 4).forEach(test => {
                    const testName = test.test_name || test.name || 'Unnamed Test';
                    const testDesc = test.description || 'No description';
                    const testId = test.test_id || test.id;
                    const status = test.status || 'active';

                    if (status === 'active') {
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">${testName}</h6>
                                        <p class="card-text small">${testDesc}</p>
                                        <button class="btn btn-sm btn-primary" onclick="alert('Test ID: ${testId}')">
                                            L√†m b√†i thi
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                html += '</div>';

                renderResult.innerHTML = html;

            } catch (error) {
                console.error('Render error:', error);
                renderResult.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Render Failed: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>