<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n ·ª©ng tuy·ªÉn c·ªßa t√¥i - CS60 Recruitment</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-xl">C</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">CS60 Recruitment</h1>
                        <p class="text-sm text-gray-600">ƒê∆°n ·ª©ng tuy·ªÉn c·ªßa t√¥i</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <a href="jobs.html" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition font-medium">
                        üîç T√¨m vi·ªác l√†m
                    </a>
                    <div id="userInfo" class="flex items-center gap-3">
                        <div class="text-right">
                            <p id="userName" class="text-sm font-medium text-gray-900"></p>
                            <p class="text-xs text-gray-500">Candidate</p>
                        </div>
                        <button onclick="logout()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-medium">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-xl shadow-md">
            <div class="px-6 py-4 border-b">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">üìã ƒê∆°n ·ª©ng tuy·ªÉn c·ªßa t√¥i</h2>
                        <p class="text-sm text-gray-600 mt-1">Theo d√µi ti·∫øn tr√¨nh ·ª©ng tuy·ªÉn c·ªßa b·∫°n</p>
                    </div>
                    <button onclick="fetchApplications()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium">
                        üîÑ L√†m m·ªõi
                    </button>
                </div>
            </div>

            <!-- Applications List -->
            <div id="applicationsContainer" class="divide-y">
                <!-- Loading -->
                <div class="p-12 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-4 text-gray-600">ƒêang t·∫£i danh s√°ch...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        let applications = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('userName').textContent = payload.full_name || payload.username;
                
                if (payload.role && payload.role.toUpperCase() !== 'CANDIDATE') {
                    alert('Trang n√†y ch·ªâ d√†nh cho ·ª©ng vi√™n');
                    window.location.href = 'index.html';
                    return false;
                }
            } catch (error) {
                console.error('Error parsing token:', error);
            }
            
            return true;
        }

        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            };
        }

        // Fetch applications
        async function fetchApplications() {
            try {
                const response = await fetch(`${API_BASE_URL}/applications/my-applications`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    applications = data.data || [];
                    renderApplications();
                } else {
                    showError(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch');
                }
            } catch (error) {
                console.error('Error fetching applications:', error);
                showError('L·ªói k·∫øt n·ªëi');
            }
        }

        function renderApplications() {
            const container = document.getElementById('applicationsContainer');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <svg class="w-24 h-24 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="mt-4 text-xl text-gray-600">B·∫°n ch∆∞a ·ª©ng tuy·ªÉn v·ªã tr√≠ n√†o</p>
                        <a href="jobs.html" class="mt-4 inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            Kh√°m ph√° vi·ªác l√†m
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = applications.map(app => {
                const statusColors = {
                    'APPLIED': 'bg-blue-100 text-blue-800',
                    'SCREENING': 'bg-yellow-100 text-yellow-800',
                    'TESTING': 'bg-purple-100 text-purple-800',
                    'INTERVIEWING': 'bg-orange-100 text-orange-800',
                    'OFFERED': 'bg-green-100 text-green-800',
                    'HIRED': 'bg-green-100 text-green-800',
                    'REJECTED': 'bg-red-100 text-red-800'
                };
                
                const statusText = {
                    'APPLIED': 'üìù ƒê√£ n·ªôp ƒë∆°n',
                    'SCREENING': 'üîç ƒêang x√©t duy·ªát',
                    'TESTING': 'üìù ƒêang l√†m b√†i test',
                    'INTERVIEWING': 'üí¨ Ph·ªèng v·∫•n',
                    'OFFERED': 'üéâ Nh·∫≠n offer',
                    'HIRED': '‚úÖ ƒê√£ tuy·ªÉn',
                    'REJECTED': '‚ùå T·ª´ ch·ªëi'
                };
                
                const companyColor = `hsl(${(app.application_id * 137.5) % 360}, 70%, 50%)`;
                const companyInitial = app.JobPosition?.Company?.companyName?.charAt(0).toUpperCase() || 'C';
                
                return `
                    <div class="p-6 hover:bg-gray-50 transition">
                        <div class="flex items-start gap-4">
                            <div class="w-16 h-16 rounded-lg flex items-center justify-center text-white font-bold text-2xl flex-shrink-0" style="background: ${companyColor};">
                                ${companyInitial}
                            </div>
                            
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">${app.JobPosition?.title || 'N/A'}</h3>
                                        <p class="text-sm text-gray-600">${app.JobPosition?.Company?.companyName || 'N/A'}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[app.status] || 'bg-gray-100 text-gray-800'}">
                                        ${statusText[app.status] || app.status}
                                    </span>
                                </div>
                                
                                <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                                    <span>üìÖ N·ªôp: ${new Date(app.application_date).toLocaleDateString('vi-VN')}</span>
                                    ${app.Recruiter ? `<span>üë§ HR: ${app.Recruiter.full_name || app.Recruiter.username}</span>` : ''}
                                </div>
                                
                                ${app.status === 'APPLIED' ? `
                                    <button onclick="cancelApplication(${app.application_id}, '${app.JobPosition?.title}')" 
                                        class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition">
                                        H·ªßy ƒë∆°n
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function cancelApplication(applicationId, jobTitle) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n ·ª©ng tuy·ªÉn "${jobTitle}"?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/applications/${applicationId}/cancel`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ ƒê√£ h·ªßy ƒë∆°n ·ª©ng tuy·ªÉn');
                    fetchApplications();
                } else {
                    alert(data.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n');
                }
            } catch (error) {
                console.error('Error canceling application:', error);
                alert('L·ªói khi h·ªßy ƒë∆°n');
            }
        }

        function showError(message) {
            document.getElementById('applicationsContainer').innerHTML = `
                <div class="p-12 text-center">
                    <svg class="w-24 h-24 mx-auto text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="mt-4 text-xl text-red-600">${message}</p>
                </div>
            `;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Initialize
        if (checkAuth()) {
            fetchApplications();
        }
    </script>
</body>
</html>
