<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoàn thành bài thi - ExamPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .completion-card {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .info-box {
            transition: transform 0.2s;
        }
        .info-box:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">ExamPro - Hệ thống thi trực tuyến</h1>
            <p class="text-purple-200">Kết quả bài thi</p>
        </div>

        <!-- Completion Card -->
        <div class="completion-card max-w-3xl mx-auto bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden">
            <!-- Success Icon -->
            <div class="bg-gradient-to-br from-green-500/20 to-blue-500/20 p-8 text-center">
                <div class="inline-block p-6 bg-white rounded-full shadow-lg mb-4">
                    <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Bài thi đã hoàn thành!</h2>
                <p class="text-gray-600 text-lg">Bài thi của bạn đã được nộp thành công</p>
            </div>

            <!-- Test Information -->
            <div class="p-8">
                <div class="space-y-4">
                    <!-- Test Name -->
                    <div class="info-box bg-gradient-to-r from-purple-500/10 to-blue-500/10 p-5 rounded-xl border border-purple-200">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-purple-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-1">Tên bài thi</p>
                                <p id="testName" class="text-lg font-semibold text-gray-800">Đang tải...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Duration -->
                    <div class="info-box bg-gradient-to-r from-blue-500/10 to-cyan-500/10 p-5 rounded-xl border border-blue-200">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-1">Thời gian làm bài</p>
                                <p id="duration" class="text-lg font-semibold text-gray-800">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- Start Time -->
                    <div class="info-box bg-gradient-to-r from-green-500/10 to-emerald-500/10 p-5 rounded-xl border border-green-200">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-green-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-1">Giờ bắt đầu</p>
                                <p id="startTime" class="text-lg font-semibold text-gray-800">--</p>
                            </div>
                        </div>
                    </div>

                    <!-- End Time -->
                    <div class="info-box bg-gradient-to-r from-orange-500/10 to-red-500/10 p-5 rounded-xl border border-orange-200">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-orange-500 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-500 mb-1">Giờ kết thúc</p>
                                <p id="endTime" class="text-lg font-semibold text-gray-800">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Status -->
                <div class="mt-8 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
                    <div class="flex items-start gap-3">
                        <div class="p-2 bg-yellow-500 rounded-lg flex-shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800 mb-2">Thông báo quan trọng</h3>
                            <p class="text-gray-700 leading-relaxed">
                                Bài thi của bạn đang được xem xét và chấm điểm bởi nhà tuyển dụng. 
                                Kết quả chi tiết sẽ được công bố sau khi quá trình đánh giá hoàn tất. 
                                Vui lòng kiểm tra lại sau hoặc chờ thông báo qua email.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex gap-4 justify-center">
                    <a href="exam.html" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-semibold rounded-lg shadow-lg transition transform hover:scale-105">
                        Quay lại trang chủ
                    </a>
                    <a href="my-tests.html" class="px-8 py-3 bg-white hover:bg-gray-50 text-gray-700 font-semibold rounded-lg border-2 border-gray-300 transition transform hover:scale-105">
                        Xem danh sách bài thi
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer Note -->
        <div class="text-center mt-8 text-white/80">
            <p class="text-sm">© 2025 ExamPro - Hệ thống thi tuyển trực tuyến</p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // Get test completion data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const candidateTestId = urlParams.get('candidateTestId');

        // Format date/time
        function formatDateTime(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Calculate duration
        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return '--';
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            
            if (hours > 0) {
                return `${hours} giờ ${mins} phút`;
            }
            return `${mins} phút`;
        }

        // Get auth headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token') || localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            console.log('Token found:', token ? 'Yes' : 'No');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        // Load test completion data
        async function loadCompletionData() {
            console.log('=== LOADING COMPLETION DATA ===');
            console.log('Candidate Test ID:', candidateTestId);
            
            if (!candidateTestId) {
                console.error('No candidate test ID provided');
                document.getElementById('testName').textContent = 'Không có thông tin bài thi';
                return;
            }

            try {
                const url = `${API_BASE_URL}/candidate-tests/${candidateTestId}`;
                console.log('Fetching URL:', url);
                
                // Fetch candidate test details
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response not OK:', errorText);
                    throw new Error(`Failed to load test data: ${response.status}`);
                }

                const result = await response.json();
                console.log('Full API response:', result);
                
                const testData = result.data;
                console.log('Test completion data:', testData);

                // Update UI with test information ONLY (NO SCORES - they're hidden until recruiter enables visibility)
                document.getElementById('testName').textContent = testData.Test?.test_name || 'Không có tên';
                document.getElementById('startTime').textContent = formatDateTime(testData.start_time);
                document.getElementById('endTime').textContent = formatDateTime(testData.end_time || new Date());
                document.getElementById('duration').textContent = calculateDuration(testData.start_time, testData.end_time || new Date());

            } catch (error) {
                console.error('=== ERROR LOADING COMPLETION DATA ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Stack:', error.stack);
                
                document.getElementById('testName').textContent = 'Lỗi tải thông tin: ' + error.message;
                
                // Show error in UI
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-4 p-4 bg-red-100 border-2 border-red-300 rounded-lg text-red-700';
                errorDiv.innerHTML = `
                    <h4 class="font-bold mb-2">❌ Lỗi tải dữ liệu</h4>
                    <p>${error.message}</p>
                    <p class="text-sm mt-2">Vui lòng thử lại hoặc liên hệ quản trị viên.</p>
                `;
                document.querySelector('.p-8').appendChild(errorDiv);
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadCompletionData);
    </script>
</body>
</html>
