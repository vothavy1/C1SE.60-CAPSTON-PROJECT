<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh S√°ch ·ª®ng Vi√™n - Recruiter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-badge {
      @apply px-3 py-1 rounded-full text-xs font-semibold inline-block;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-800 via-indigo-900 to-slate-900 min-h-screen text-white">
  
  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-indigo-400/30">
    <div class="max-w-7xl mx-auto flex justify-between items-center py-4 px-6">
      <div class="flex items-center gap-4">
        <a href="recruiter.html" class="text-2xl hover:text-indigo-300 transition">‚Üê</a>
        <h1 class="text-2xl md:text-3xl font-bold">üìã Qu·∫£n L√Ω ·ª®ng Vi√™n</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="userName" class="text-indigo-200">Xin ch√†o!</span>
        <button onclick="logout()" class="bg-gradient-to-r from-pink-500 to-purple-600 px-4 py-2 rounded-lg hover:opacity-90 transition">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto mt-6 p-6">
    
    <!-- Actions Bar -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between border border-white/20">
      <div class="flex gap-3 flex-wrap">
        <button onclick="showAddModal()" class="bg-gradient-to-r from-green-500 to-emerald-600 px-4 py-2 rounded-lg hover:opacity-90 transition">
          ‚ûï Th√™m ·ª©ng vi√™n
        </button>
        <button onclick="refreshList()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg transition">
          L√†m m·ªõi
        </button>
      </div>
      
      <!-- Search & Filter -->
      <div class="flex gap-3 flex-wrap flex-1 max-w-4xl">
        <input 
          id="searchInput" 
          type="text" 
          placeholder="T√¨m theo t√™n, email, v·ªã tr√≠..." 
          class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          onkeyup="searchCandidates()"
        />
        <div class="flex gap-2 items-center">
          <label class="text-sm whitespace-nowrap">T·ª´ ng√†y:</label>
          <input 
            id="fromDate" 
            type="date" 
            onchange="filterByDate()" 
            class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm"
          />
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm whitespace-nowrap">ƒê·∫øn ng√†y:</label>
          <input 
            id="toDate" 
            type="date" 
            onchange="filterByDate()" 
            class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm"
          />
        </div>
      </div>
    </div>

    <!-- Candidates Table -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl overflow-hidden border border-white/20">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-white/10">
            <tr>
              <th class="px-6 py-4 text-left font-semibold">ID</th>
              <th class="px-6 py-4 text-left font-semibold">H·ªç t√™n</th>
              <th class="px-6 py-4 text-left font-semibold">Email</th>
              <th class="px-6 py-4 text-left font-semibold">S·ªë ƒëi·ªán tho·∫°i</th>
              <th class="px-6 py-4 text-left font-semibold">V·ªã tr√≠</th>
              <th class="px-6 py-4 text-left font-semibold">C√¥ng ty</th>
              <th class="px-6 py-4 text-left font-semibold">Kinh nghi·ªám</th>
              <th class="px-6 py-4 text-left font-semibold">Tr·∫°ng th√°i</th>
              <th class="px-6 py-4 text-left font-semibold">Ng√†y t·∫°o</th>
              <th class="px-6 py-4 text-center font-semibold">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="candidatesTableBody" class="divide-y divide-white/10">
            <tr>
              <td colspan="10" class="px-6 py-8 text-center text-gray-400">
                ƒêang t·∫£i d·ªØ li·ªáu...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div id="paginationContainer" class="bg-white/5 px-6 py-4 flex justify-between items-center border-t border-white/10">
        <div class="text-sm text-gray-300">
          Hi·ªÉn th·ªã <span id="showingFrom">0</span> - <span id="showingTo">0</span> c·ªßa <span id="totalRecords">0</span> b·∫£n ghi
        </div>
        <div id="paginationButtons" class="flex gap-2">
          <!-- Pagination buttons will be inserted here -->
        </div>
      </div>
    </div>

  </main>

  <!-- Add/Edit Candidate Modal -->
  <div id="candidateModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-indigo-400/30 shadow-2xl">
      <div class="sticky top-0 bg-slate-800 border-b border-white/10 px-6 py-4 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-bold">Th√™m ·ª®ng Vi√™n M·ªõi</h2>
        <button onclick="closeModal()" class="text-3xl hover:text-red-400 transition">&times;</button>
      </div>
      
      <form id="candidateForm" class="p-6 space-y-4">
        <input type="hidden" id="candidateId" />
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">H·ªç *</label>
            <input type="text" id="firstName" required 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">T√™n *</label>
            <input type="text" id="lastName" required 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Email *</label>
          <input type="email" id="email" required 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i *</label>
          <input type="tel" id="phone" required
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">V·ªã tr√≠ hi·ªán t·∫°i</label>
          <input type="text" id="currentPosition"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">S·ªë nƒÉm kinh nghi·ªám</label>
          <input type="number" id="yearsOfExperience" min="0"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">H·ªçc v·∫•n</label>
          <input type="text" id="education"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" 
            placeholder="V√≠ d·ª•: ƒê·∫°i h·ªçc C√¥ng ngh·ªá Th√¥ng tin" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">K·ªπ nƒÉng</label>
          <textarea id="skills" rows="2"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"
            placeholder="JavaScript, React, Node.js, ..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Ngu·ªìn ·ª©ng tuy·ªÉn *</label>
          <select id="source" required
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            <option value="">-- Ch·ªçn ngu·ªìn --</option>
            <option value="WEBSITE">Website</option>
            <option value="LINKEDIN">LinkedIn</option>
            <option value="REFERRAL">Gi·ªõi thi·ªáu</option>
            <option value="JOB_BOARD">Trang tuy·ªÉn d·ª•ng</option>
            <option value="OTHER">Kh√°c</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Ghi ch√∫</label>
          <textarea id="notes" rows="3"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"
            placeholder="Ghi ch√∫ v·ªÅ ·ª©ng vi√™n..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Tr·∫°ng th√°i</label>
          <select id="status" 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            <option value="NEW">M·ªõi</option>
            <option value="SCREENING">S√†ng l·ªçc</option>
            <option value="TESTING">ƒêang test</option>
            <option value="INTERVIEWING">Ph·ªèng v·∫•n</option>
            <option value="OFFERED">ƒê√£ offer</option>
            <option value="HIRED">ƒê√£ tuy·ªÉn</option>
            <option value="REJECTED">T·ª´ ch·ªëi</option>
          </select>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 px-6 py-3 rounded-lg font-semibold transition">
            üíæ L∆∞u
          </button>
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-lg font-semibold transition">
            H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let allCandidates = [];
    let filteredCandidates = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      console.log('üì§ Getting auth headers, token exists:', !!token);
      
      if (!token) {
        console.error('‚ùå No token for auth headers');
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
        window.location.href = 'login.html';
        return null;
      }
      
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
      
      console.log('‚úÖ Auth headers prepared:', { 
        hasContentType: !!headers['Content-Type'],
        hasAuthorization: !!headers['Authorization'],
        authPrefix: headers['Authorization'].substring(0, 20) + '...'
      });
      
      return headers;
    }

    // Parse JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      
      console.log('üîê Auth Check:', {
        hasToken: !!token,
        tokenLength: token ? token.length : 0,
        hasSession: !!localStorage.getItem('session_user')
      });
      
      if (!token) {
        console.error('‚ùå No token found in localStorage');
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
        window.location.href = 'login.html';
        return false;
      }

      // Parse token to check company_id
      const tokenPayload = parseJwt(token);
      if (tokenPayload) {
        console.log('üîç Token Payload:', tokenPayload);
        
        // Check if token has company_id (for recruiter role)
        if (tokenPayload.role && tokenPayload.role.toUpperCase() === 'RECRUITER' && !tokenPayload.company_id) {
          console.error('‚ö†Ô∏è Token kh√¥ng c√≥ company_id - c·∫ßn login l·∫°i!');
          
          // Show warning banner
          const warningBanner = document.createElement('div');
          warningBanner.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl border-2 border-red-400';
          warningBanner.innerHTML = `
            <div class="flex items-center gap-4">
              <span class="text-3xl">‚ö†Ô∏è</span>
              <div>
                <p class="font-bold text-lg">C·∫¢NH B√ÅO: Token c≈© kh√¥ng c√≥ Company ID!</p>
                <p class="text-sm mt-1">B·∫°n ƒëang th·∫•y d·ªØ li·ªáu c·ªßa T·∫§T C·∫¢ c√¥ng ty. Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i!</p>
              </div>
              <button onclick="logout()" class="ml-4 bg-white text-red-600 px-4 py-2 rounded font-bold hover:bg-gray-100">
                ƒêƒÉng xu·∫•t ngay
              </button>
            </div>
          `;
          document.body.appendChild(warningBanner);
        }
      }

      const session = JSON.parse(localStorage.getItem('session_user') || 'null');
      
      // If we have a token but no session, allow access (session might not be set in older logins)
      if (session) {
        const role = String(session.role || '').toUpperCase();
        if (role !== 'RECRUITER' && role !== 'ADMIN') {
          alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
          window.location.href = 'exam.html';
          return false;
        }
        // Display user name
        document.getElementById('userName').textContent = `Xin ch√†o, ${session.fullName || session.username}!`;
      } else {
        // No session data, but we have token - show generic greeting
        document.getElementById('userName').textContent = `Xin ch√†o!`;
      }
      
      return true;
    }

    // Logout
    function logout() {
      // üî• X√ìA T·∫§T C·∫¢ D·ªÆ LI·ªÜU
      localStorage.clear();
      sessionStorage.clear();
      
      // Clear cookies n·∫øu c√≥
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
      });
      
      // Force reload to clear cache
      window.location.href = 'index.html?t=' + Date.now();
    }

    // Get status text only (no colored badges)
    function getStatusText(status) {
      const statusText = {
        'NEW': 'M·ªõi',
        'SCREENING': 'S√†ng l·ªçc',
        'TESTING': 'ƒêang test',
        'INTERVIEWING': 'Ph·ªèng v·∫•n',
        'OFFERED': 'ƒê√£ offer',
        'HIRED': 'ƒê√£ tuy·ªÉn',
        'REJECTED': 'T·ª´ ch·ªëi'
      };
      
      return statusText[status] || status;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
      });
    }

    // Load all candidates
    async function loadCandidates() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/candidates`, {
          headers: headers
        });

        if (response.status === 401 || response.status === 403) {
          const errorData = await response.json().catch(() => ({}));
          if (errorData.error_code === 'OLD_TOKEN') {
            alert('‚ö†Ô∏è TOKEN C≈® KH√îNG H·ª¢P L·ªÜ!\n\nH·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ b·∫£o m·∫≠t d·ªØ li·ªáu theo c√¥ng ty.\n\nB·∫°n ƒëang d√πng token c≈© kh√¥ng c√≥ company_id.\n\n‚û°Ô∏è VUI L√íNG ƒêƒÇNG XU·∫§T V√Ä ƒêƒÇNG NH·∫¨P L·∫†I!');
            logout();
          } else {
            alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
            window.location.href = 'login.html';
          }
          return;
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to load candidates');
        }

        const data = await response.json();
        
        // Ensure we always get an array
        if (Array.isArray(data.data)) {
          allCandidates = data.data;
        } else if (Array.isArray(data)) {
          allCandidates = data;
        } else {
          console.warn('‚ö†Ô∏è Unexpected response format:', data);
          allCandidates = [];
        }
        
        filteredCandidates = [...allCandidates];
        
        renderTable();
        console.log('‚úÖ Loaded candidates:', allCandidates.length);
      } catch (error) {
        console.error('‚ùå Error loading candidates:', error);
        allCandidates = [];
        filteredCandidates = [];
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="10" class="px-6 py-8 text-center text-red-400">
              L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Update statistics - removed (no longer needed)

    // Render table
    function renderTable() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredCandidates.slice(start, end);

      if (pageData.length === 0) {
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="10" class="px-6 py-8 text-center text-gray-400">
              Kh√¥ng c√≥ ·ª©ng vi√™n n√†o
            </td>
          </tr>
        `;
        return;
      }

      const html = pageData.map(candidate => `
        <tr class="hover:bg-white/5 transition">
          <td class="px-6 py-4">${candidate.candidate_id}</td>
          <td class="px-6 py-4 font-semibold">${candidate.first_name} ${candidate.last_name}</td>
          <td class="px-6 py-4 text-indigo-300">${candidate.email}</td>
          <td class="px-6 py-4">${candidate.phone || '-'}</td>
          <td class="px-6 py-4">${candidate.position || candidate.current_position || '-'}</td>
          <td class="px-6 py-4">${candidate.company_name || '-'}</td>
          <td class="px-6 py-4">${candidate.experience_years || candidate.years_of_experience || 0} nƒÉm</td>
          <td class="px-6 py-4">${getStatusText(candidate.status)}</td>
          <td class="px-6 py-4 text-sm text-gray-300">${formatDate(candidate.created_at)}</td>
          <td class="px-6 py-4">
            <div class="flex justify-center gap-2 flex-wrap">
              <button onclick="viewCV(${candidate.candidate_id})" 
                class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded transition text-sm" title="Xem CV trong tab m·ªõi">
                Xem
              </button>
              <button onclick="downloadCV(${candidate.candidate_id})" 
                class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded transition text-sm" title="T·∫£i CV v·ªÅ m√°y">
                T·∫£i
              </button>
              <button onclick="updateStatusPass(${candidate.candidate_id})" 
                class="px-3 py-1 bg-green-600 hover:bg-green-500 rounded transition text-sm" title="Pass">
                Pass
              </button>
              <button onclick="updateStatusFail(${candidate.candidate_id})" 
                class="px-3 py-1 bg-red-600 hover:bg-red-500 rounded transition text-sm" title="Fail">
                Fail
              </button>
              <button onclick="editCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 bg-yellow-600 hover:bg-yellow-500 rounded transition text-sm" title="S·ª≠a">
                S·ª≠a
              </button>
              <button onclick="deleteCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded transition text-sm" title="X√≥a">
                X√≥a
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      document.getElementById('candidatesTableBody').innerHTML = html;
      updatePagination();
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(filteredCandidates.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(start + itemsPerPage - 1, filteredCandidates.length);

      document.getElementById('showingFrom').textContent = filteredCandidates.length > 0 ? start : 0;
      document.getElementById('showingTo').textContent = end;
      document.getElementById('totalRecords').textContent = filteredCandidates.length;

      let buttonsHTML = '';
      
      if (currentPage > 1) {
        buttonsHTML += `<button onclick="goToPage(${currentPage - 1})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">‚Üê Tr∆∞·ªõc</button>`;
      }

      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          buttonsHTML += `<button class="px-3 py-1 bg-indigo-600 rounded font-semibold">${i}</button>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          buttonsHTML += `<button onclick="goToPage(${i})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">${i}</button>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          buttonsHTML += `<span class="px-2">...</span>`;
        }
      }

      if (currentPage < totalPages) {
        buttonsHTML += `<button onclick="goToPage(${currentPage + 1})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">Sau ‚Üí</button>`;
      }

      document.getElementById('paginationButtons').innerHTML = buttonsHTML;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    // Search candidates
    function searchCandidates() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      filteredCandidates = allCandidates.filter(candidate => {
        const matchesSearch = 
          candidate.first_name.toLowerCase().includes(searchTerm) ||
          candidate.last_name.toLowerCase().includes(searchTerm) ||
          candidate.email.toLowerCase().includes(searchTerm) ||
          (candidate.current_position && candidate.current_position.toLowerCase().includes(searchTerm)) ||
          (candidate.skills && candidate.skills.toLowerCase().includes(searchTerm));
        
        // Date filtering
        let matchesDate = true;
        if (fromDate || toDate) {
          const candidateDate = candidate.created_at ? new Date(candidate.created_at) : null;
          if (candidateDate) {
            if (fromDate) {
              const from = new Date(fromDate);
              from.setHours(0, 0, 0, 0);
              matchesDate = matchesDate && candidateDate >= from;
            }
            if (toDate) {
              const to = new Date(toDate);
              to.setHours(23, 59, 59, 999);
              matchesDate = matchesDate && candidateDate <= to;
            }
          } else {
            matchesDate = false;
          }
        }

        return matchesSearch && matchesDate;
      });

      currentPage = 1;
      renderTable();
    }

    // Filter by date
    function filterByDate() {
      searchCandidates();
    }

    // Refresh list
    function refreshList() {
      document.getElementById('searchInput').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      loadCandidates();
    }

    // Show add modal
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'Th√™m ·ª®ng Vi√™n M·ªõi';
      document.getElementById('candidateId').value = '';
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('email').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('currentPosition').value = '';
      document.getElementById('yearsOfExperience').value = '';
      document.getElementById('education').value = '';
      document.getElementById('skills').value = '';
      document.getElementById('source').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('status').value = 'NEW';

      document.getElementById('candidateModal').classList.remove('hidden');
      document.getElementById('candidateModal').classList.add('flex');
    }

    // Close modal
    function closeModal() {
      document.getElementById('candidateModal').classList.add('hidden');
      document.getElementById('candidateModal').classList.remove('flex');
    }

    // View CV in new tab (inline display)
    function viewCV(id) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
        window.location.href = 'login.html';
        return;
      }
      
      // Open in new tab with token in Authorization header via fetch and blob
      const url = `${API_BASE_URL}/candidates/${id}/cv`;
      
      fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i CV');
        }
        return response.blob();
      })
      .then(blob => {
        // Create a blob URL and open in new tab
        const blobUrl = URL.createObjectURL(blob);
        window.open(blobUrl, '_blank');
        
        // Clean up the blob URL after some time
        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
      })
      .catch(error => {
        console.error('Error viewing CV:', error);
        alert('L·ªói khi xem CV: ' + error.message);
      });
    }

    // Download CV to computer
    function downloadCV(id) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
        window.location.href = 'login.html';
        return;
      }
      
      const url = `${API_BASE_URL}/candidates/${id}/cv/download`;
      
      fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i CV');
        }
        
        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `CV_Candidate_${id}.pdf`;
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
          if (filenameMatch && filenameMatch[1]) {
            filename = filenameMatch[1];
          }
        }
        
        return response.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        // Create download link
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up
        setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
        
        console.log('‚úÖ CV downloaded successfully');
      })
      .catch(error => {
        console.error('Error downloading CV:', error);
        alert('L·ªói khi t·∫£i CV: ' + error.message);
      });
    }

    // Update status to Pass (HIRED)
    async function updateStatusPass(id) {
      if (!confirm('X√°c nh·∫≠n PASS ·ª©ng vi√™n n√†y? H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o t√†i kho·∫£n v√† g·ª≠i email th√¥ng b√°o.')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/candidates/${id}/status`, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify({ 
            status: 'HIRED',
            notes: 'PASS - ƒê√£ duy·ªát CV v√† t·∫°o t√†i kho·∫£n'
          })
        });

        if (response.status === 401 || response.status === 403) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to update status');
        }

        const data = await response.json();
        console.log('‚úÖ Response:', data);
        
        let message = data.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng!';
        if (data.data && data.data.email_sent) {
          message += '\n‚úÖ Email ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: ' + data.data.email;
        }
        if (data.data && data.data.account_created && data.data.username) {
          message += '\n‚úÖ T√†i kho·∫£n ƒë√£ t·∫°o: ' + data.data.username;
        }
        
        alert(message);
        loadCandidates(); // Reload list
      } catch (error) {
        console.error('‚ùå Error updating status:', error);
        alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message);
      }
    }

    // Update status to Fail (REJECTED)
    async function updateStatusFail(id) {
      if (!confirm('X√°c nh·∫≠n FAIL ·ª©ng vi√™n n√†y? H·ªá th·ªëng s·∫Ω g·ª≠i email th√¥ng b√°o t·ª´ ch·ªëi.')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/candidates/${id}/status`, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify({ 
            status: 'REJECTED',
            notes: 'FAIL - Kh√¥ng ƒë·∫°t y√™u c·∫ßu'
          })
        });

        if (response.status === 401 || response.status === 403) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to update status');
        }

        const data = await response.json();
        console.log('‚úÖ Response:', data);
        
        let message = data.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng!';
        if (data.data && data.data.email_sent) {
          message += '\n‚úÖ Email t·ª´ ch·ªëi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: ' + data.data.email;
        }
        
        alert(message);
        loadCandidates(); // Reload list
      } catch (error) {
        console.error('‚ùå Error updating status:', error);
        alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message);
      }
    }

    // View candidate
    function viewCandidate(id) {
      alert('Chi ti·∫øt ·ª©ng vi√™n ID: ' + id + '\n(Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn)');
    }

    // Edit candidate
    async function editCandidate(id) {
      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/candidates/${id}`, {
          headers: headers
        });

        if (response.status === 401 || response.status === 403) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) throw new Error('Failed to load candidate');

        const data = await response.json();
        const candidate = data.data;

        console.log('üìù Loading candidate for edit:', candidate);

        document.getElementById('modalTitle').textContent = 'S·ª≠a Th√¥ng Tin ·ª®ng Vi√™n';
        document.getElementById('candidateId').value = candidate.candidate_id;
        document.getElementById('firstName').value = candidate.first_name || '';
        document.getElementById('lastName').value = candidate.last_name || '';
        document.getElementById('email').value = candidate.email || '';
        document.getElementById('phone').value = candidate.phone || '';
        document.getElementById('currentPosition').value = candidate.current_position || '';
        document.getElementById('yearsOfExperience').value = candidate.years_of_experience || '';
        document.getElementById('education').value = candidate.education || '';
        document.getElementById('skills').value = candidate.skills || '';
        document.getElementById('source').value = candidate.source || '';
        document.getElementById('notes').value = candidate.notes || '';
        document.getElementById('status').value = candidate.status || 'NEW';

        document.getElementById('candidateModal').classList.remove('hidden');
        document.getElementById('candidateModal').classList.add('flex');
      } catch (error) {
        console.error('‚ùå Error loading candidate:', error);
        alert('L·ªói khi t·∫£i th√¥ng tin ·ª©ng vi√™n: ' + error.message);
      }
    }

    // Delete candidate
    async function deleteCandidate(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·ª©ng vi√™n n√†y?')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/candidates/${id}`, {
          method: 'DELETE',
          headers: headers
        });

        if (response.status === 401 || response.status === 403) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) throw new Error('Failed to delete candidate');

        alert('‚úÖ ƒê√£ x√≥a ·ª©ng vi√™n th√†nh c√¥ng!');
        loadCandidates();
      } catch (error) {
        console.error('Error deleting candidate:', error);
        alert('‚ùå L·ªói khi x√≥a ·ª©ng vi√™n: ' + error.message);
      }
    }

    // Handle form submit
    document.getElementById('candidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const candidateId = document.getElementById('candidateId').value;
      
      const candidateData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        current_position: document.getElementById('currentPosition').value,
        years_of_experience: document.getElementById('yearsOfExperience').value,
        education: document.getElementById('education').value,
        skills: document.getElementById('skills').value,
        source: document.getElementById('source').value,
        notes: document.getElementById('notes').value,
        status: document.getElementById('status').value
      };

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        let response;
        if (candidateId) {
          // Update existing candidate
          response = await fetch(`${API_BASE_URL}/candidates/${candidateId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(candidateData)
          });
        } else {
          // Create new candidate
          response = await fetch(`${API_BASE_URL}/candidates`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(candidateData)
          });
        }

        if (response.status === 401 || response.status === 403) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save candidate');
        }

        const result = await response.json();
        alert(candidateId ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ·ª©ng vi√™n th√†nh c√¥ng!' : '‚úÖ ƒê√£ th√™m ·ª©ng vi√™n m·ªõi th√†nh c√¥ng!');
        closeModal();
        loadCandidates();
      } catch (error) {
        console.error('Error saving candidate:', error);
        alert('‚ùå L·ªói: ' + error.message);
      }
    });

    // Initialize
    if (checkAuth()) {
      loadCandidates();
    }
  </script>

</body>
</html>
