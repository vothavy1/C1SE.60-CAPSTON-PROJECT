<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh SÃ¡ch á»¨ng ViÃªn - Recruiter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="theme.css">
  <script src="theme.js"></script>
  <style>
    .status-badge {
      @apply px-3 py-1 rounded-full text-xs font-semibold inline-block;
    }
    
    /* Professional Light Mode Theme */
    body {
      background-color: #f3f4f6;
      color: #1f2937;
    }
    
    .card-shadow {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .card-shadow-lg {
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="light-mode min-h-screen transition-colors duration-300">
  
  <script>
    // CRITICAL: Check token validity on page load and clear old tokens
    (function checkTokenValidity() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        
        if (!token || !session) {
          console.warn('âš ï¸ No token or session found');
          window.location.href = 'index.html';
          return;
        }

        // Check token format and parse to verify it has company_id
        try {
          const tokenParts = token.split('.');
          if (tokenParts.length === 3) {
            const payload = JSON.parse(atob(tokenParts[1]));
            const role = String(session.role || payload.role || '').toUpperCase();
            
            // For RECRUITER, company_id is MANDATORY
            if (role === 'RECRUITER') {
              const hasCompanyInToken = payload.company_id != null && payload.company_id !== undefined;
              const hasCompanyInSession = session.company_id != null && session.company_id !== undefined;
              
              if (!hasCompanyInToken || !hasCompanyInSession) {
                console.error('âŒ OLD TOKEN DETECTED! Recruiter token missing company_id');
                console.log('Token company_id:', payload.company_id);
                console.log('Session company_id:', session.company_id);
                
                alert('ğŸ”„ Há»† THá»NG ÄÃƒ Cáº¬P NHáº¬T!\n\nÄá»ƒ Ä‘áº£m báº£o báº¡n chá»‰ tháº¥y dá»¯ liá»‡u cá»§a cÃ´ng ty mÃ¬nh, há»‡ thá»‘ng yÃªu cáº§u báº¡n Ä‘Äƒng nháº­p láº¡i.\n\nâœ… Dá»¯ liá»‡u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c báº£o vá»‡ theo cÃ´ng ty.\n\nâ¡ï¸ Nháº¥n OK Ä‘á»ƒ Ä‘Äƒng nháº­p láº¡i.');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
                return;
              }
              
              console.log(`âœ… Valid recruiter token with company_id: ${payload.company_id}`);
            }
          }
        } catch (tokenParseError) {
          console.error('âŒ Cannot parse token:', tokenParseError);
          localStorage.clear();
          window.location.href = 'index.html';
          return;
        }

        console.log(`âœ… Token check passed for ${session.username} (Company: ${session.company_id || 'N/A'})`);
      } catch (error) {
        console.error('âŒ Token validation error:', error);
        localStorage.clear();
        window.location.href = 'index.html';
      }
    })();
  </script>
  
  <!-- Header -->
  <header class="header-bg shadow-md sticky top-0 z-50 border-b transition-colors duration-300">
    <div class="max-w-7xl mx-auto flex justify-between items-center py-4 px-6">
      <div class="flex items-center gap-4">
        <a href="recruiter.html" class="text-2xl hover:opacity-70 transition">â†</a>
        <h1 class="text-2xl md:text-3xl font-bold">ğŸ“‹ Quáº£n LÃ½ á»¨ng ViÃªn</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="theme-toggle" id="themeToggle" title="Chuyá»ƒn Ä‘á»•i sÃ¡ng/tá»‘i"></div>
        <span id="userName" class="font-medium">Xin chÃ o!</span>
        <button onclick="logout()" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:opacity-90 transition shadow-md">
          ÄÄƒng xuáº¥t
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto mt-6 p-6">
    
    <!-- Actions Bar -->
    <div class="content-card rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between border transition-all duration-300">
      <div class="flex gap-3 flex-wrap">
        <button onclick="showAddModal()" class="btn-primary px-4 py-2 rounded-lg transition shadow-md">
          â• ThÃªm á»©ng viÃªn
        </button>
        <button onclick="refreshList()" class="btn-secondary px-4 py-2 rounded-lg transition shadow-md">
          LÃ m má»›i
        </button>
      </div>
      
      <!-- Search & Filter -->
      <div class="flex gap-3 flex-wrap flex-1 max-w-4xl">
        <input 
          id="searchInput" 
          type="text" 
          placeholder="TÃ¬m theo tÃªn, email, vá»‹ trÃ­..." 
          class="flex-1 px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 transition-colors duration-300"
          onkeyup="searchCandidates()"
        />
        <div class="flex gap-2 items-center">
          <label class="text-sm whitespace-nowrap font-medium">Tá»« ngÃ y:</label>
          <input 
            id="fromDate" 
            type="date" 
            onchange="filterByDate()" 
            class="px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 transition-colors duration-300 text-sm"
          />
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm whitespace-nowrap font-medium">Äáº¿n ngÃ y:</label>
          <input 
            id="toDate" 
            type="date" 
            onchange="filterByDate()" 
            class="px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 transition-colors duration-300 text-sm"
          />
        </div>
      </div>
    </div>

    <!-- Candidates Table -->
    <div class="content-card rounded-xl overflow-hidden border transition-all duration-300">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">ID</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Há» tÃªn</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Email</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Sá»‘ Ä‘iá»‡n thoáº¡i</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Vá»‹ trÃ­</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">CÃ´ng ty</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Kinh nghiá»‡m</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Tráº¡ng thÃ¡i</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">NgÃ y táº¡o</th>
              <th class="px-6 py-4 text-center font-semibold text-gray-700">Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody id="candidatesTableBody" class="divide-y divide-gray-200">
            <tr>
              <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                Äang táº£i dá»¯ liá»‡u...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div id="paginationContainer" class="bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-200">
        <div class="text-sm text-gray-600 font-medium">
          Hiá»ƒn thá»‹ <span id="showingFrom">0</span> - <span id="showingTo">0</span> cá»§a <span id="totalRecords">0</span> báº£n ghi
        </div>
        <div id="paginationButtons" class="flex gap-2">
          <!-- Pagination buttons will be inserted here -->
        </div>
      </div>
    </div>

  </main>

  <!-- Add/Edit Candidate Modal -->
  <div id="candidateModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-200 card-shadow-lg">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-2xl">
        <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">ThÃªm á»¨ng ViÃªn Má»›i</h2>
        <button onclick="closeModal()" class="text-3xl text-gray-500 hover:text-red-500 transition">&times;</button>
      </div>
      
      <form id="candidateForm" class="p-6 space-y-4">
        <input type="hidden" id="candidateId" />
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">Há» *</label>
            <input type="text" id="firstName" required 
              class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">TÃªn *</label>
            <input type="text" id="lastName" required 
              class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Email *</label>
          <input type="email" id="email" required 
            pattern="[a-zA-Z0-9._%+-]+@gmail\.com$"
            placeholder="example123@gmail.com"
            title="Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com (vÃ­ dá»¥: user123@gmail.com)"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          <small class="text-gray-500 text-xs mt-1 block">Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com</small>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Sá»‘ Ä‘iá»‡n thoáº¡i *</label>
          <input type="tel" id="phone" required
            pattern="[0-9]{10,11}"
            placeholder="0912345678"
            title="Sá»‘ Ä‘iá»‡n thoáº¡i chá»‰ Ä‘Æ°á»£c phÃ©p nháº­p sá»‘ (10-11 chá»¯ sá»‘)"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          <small class="text-gray-500 text-xs mt-1 block">Chá»‰ Ä‘Æ°á»£c nháº­p sá»‘, tá»« 10-11 chá»¯ sá»‘</small>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Vá»‹ trÃ­ hiá»‡n táº¡i</label>
          <input type="text" id="currentPosition"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Sá»‘ nÄƒm kinh nghiá»‡m</label>
          <input type="number" id="yearsOfExperience" min="0"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Há»c váº¥n</label>
          <input type="text" id="education"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
            placeholder="VÃ­ dá»¥: Äáº¡i há»c CÃ´ng nghá»‡ ThÃ´ng tin" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Ká»¹ nÄƒng</label>
          <textarea id="skills" rows="2"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="JavaScript, React, Node.js, ..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Nguá»“n á»©ng tuyá»ƒn *</label>
          <select id="source" required
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="">-- Chá»n nguá»“n --</option>
            <option value="WEBSITE">Website</option>
            <option value="LINKEDIN">LinkedIn</option>
            <option value="REFERRAL">Giá»›i thiá»‡u</option>
            <option value="JOB_BOARD">Trang tuyá»ƒn dá»¥ng</option>
            <option value="OTHER">KhÃ¡c</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Ghi chÃº</label>
          <textarea id="notes" rows="3"
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Ghi chÃº vá» á»©ng viÃªn..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700">Tráº¡ng thÃ¡i</label>
          <select id="status" 
            class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="NEW">Má»›i</option>
            <option value="SCREENING">SÃ ng lá»c</option>
            <option value="TESTING">Äang test</option>
            <option value="INTERVIEWING">Phá»ng váº¥n</option>
            <option value="OFFERED">ÄÃ£ offer</option>
            <option value="HIRED">ÄÃ£ tuyá»ƒn</option>
            <option value="REJECTED">Tá»« chá»‘i</option>
          </select>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
            ğŸ’¾ LÆ°u
          </button>
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
            Há»§y
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ğŸ”¥ FORCE CLEAR CACHE ON NEW LOGIN
    (function checkCacheBust() {
      const lastPageLoad = sessionStorage.getItem('candidate_page_loaded');
      const loginTime = localStorage.getItem('login_timestamp');
      
      if (loginTime && (!lastPageLoad || parseInt(lastPageLoad) < parseInt(loginTime))) {
        console.log('ğŸ”„ New login detected, clearing page cache...');
        sessionStorage.setItem('candidate_page_loaded', Date.now().toString());
        // Force reload without cache
        if (!window.location.search.includes('nocache')) {
          window.location.href = window.location.pathname + '?nocache=' + Date.now();
          return;
        }
      }
    })();

    const API_BASE_URL = 'http://localhost:5000/api';
    let allCandidates = [];
    let filteredCandidates = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Get auth headers
    // Add timestamp to URL to prevent caching
    function addCacheBuster(url) {
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}_t=${new Date().getTime()}`;
    }

    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      console.log('ğŸ“¤ Getting auth headers, token exists:', !!token);
      
      if (!token) {
        console.error('âŒ No token for auth headers');
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
        window.location.href = 'login.html';
        return null;
      }
      
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      };
      
      console.log('âœ… Auth headers prepared with cache-busting:', { 
        hasContentType: !!headers['Content-Type'],
        hasAuthorization: !!headers['Authorization'],
        hasCacheControl: !!headers['Cache-Control'],
        authPrefix: headers['Authorization'].substring(0, 20) + '...'
      });
      
      return headers;
    }

    // Parse JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('token');
      
      console.log('ğŸ” Auth Check:', {
        hasToken: !!token,
        tokenLength: token ? token.length : 0,
        hasSession: !!localStorage.getItem('session_user')
      });
      
      if (!token) {
        console.error('âŒ No token found in localStorage');
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
        window.location.href = 'login.html';
        return false;
      }

      // Parse token to check company_id
      const tokenPayload = parseJwt(token);
      if (tokenPayload) {
        console.log('ğŸ” Token Payload:', tokenPayload);
        
        // Check if token has company_id (for recruiter role)
        if (tokenPayload.role && tokenPayload.role.toUpperCase() === 'RECRUITER' && !tokenPayload.company_id) {
          console.error('âš ï¸ Token khÃ´ng cÃ³ company_id - cáº§n login láº¡i!');
          
          // Show warning banner
          const warningBanner = document.createElement('div');
          warningBanner.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-red-600 text-white px-6 py-4 rounded-lg shadow-2xl border-2 border-red-500';
          warningBanner.innerHTML = `
            <div class="flex items-center gap-4">
              <span class="text-3xl">âš ï¸</span>
              <div>
                <p class="font-bold text-lg text-white">Cáº¢NH BÃO: Token cÅ© khÃ´ng cÃ³ Company ID!</p>
                <p class="text-sm mt-1 text-white">Báº¡n Ä‘ang tháº¥y dá»¯ liá»‡u cá»§a Táº¤T Cáº¢ cÃ´ng ty. Vui lÃ²ng Ä‘Äƒng xuáº¥t vÃ  Ä‘Äƒng nháº­p láº¡i!</p>
              </div>
              <button onclick="logout()" class="ml-4 bg-white text-red-600 px-4 py-2 rounded font-bold hover:bg-gray-100 shadow-md">
                ÄÄƒng xuáº¥t ngay
              </button>
            </div>
          `;
          document.body.appendChild(warningBanner);
        }
      }

      const session = JSON.parse(localStorage.getItem('session_user') || 'null');
      
      // If we have a token but no session, allow access (session might not be set in older logins)
      if (session) {
        const role = String(session.role || '').toUpperCase();
        if (role !== 'RECRUITER' && role !== 'ADMIN') {
          alert('Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p trang nÃ y');
          window.location.href = 'exam.html';
          return false;
        }
        // Display user name
        document.getElementById('userName').textContent = `Xin chÃ o, ${session.fullName || session.username}!`;
      } else {
        // No session data, but we have token - show generic greeting
        document.getElementById('userName').textContent = `Xin chÃ o!`;
      }
      
      return true;
    }

    // Logout
    function logout() {
      // ğŸ”¥ XÃ“A Táº¤T Cáº¢ Dá»® LIá»†U
      localStorage.clear();
      sessionStorage.clear();
      
      // Clear cookies náº¿u cÃ³
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
      });
      
      // Force reload to clear cache
      window.location.href = 'index.html?t=' + Date.now();
    }

    // Get status text only (no colored badges)
    function getStatusText(status) {
      const statusText = {
        'NEW': 'Má»›i',
        'SCREENING': 'SÃ ng lá»c',
        'TESTING': 'Äang test',
        'INTERVIEWING': 'Phá»ng váº¥n',
        'OFFERED': 'ÄÃ£ offer',
        'HIRED': 'ÄÃ£ tuyá»ƒn',
        'REJECTED': 'Tá»« chá»‘i'
      };
      
      return statusText[status] || status;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
      });
    }

    // Load all candidates
    async function loadCandidates() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const response = await fetch(`${API_BASE_URL}/apply/candidates?_t=${timestamp}`, {
          headers: headers,
          cache: 'no-store' // Force no caching
        });

        if (response.status === 401 || response.status === 403) {
          const errorData = await response.json().catch(() => ({}));
          if (errorData.error_code === 'OLD_TOKEN') {
            alert('âš ï¸ TOKEN CÅ¨ KHÃ”NG Há»¢P Lá»†!\n\nHá»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ báº£o máº­t dá»¯ liá»‡u theo cÃ´ng ty.\n\nBáº¡n Ä‘ang dÃ¹ng token cÅ© khÃ´ng cÃ³ company_id.\n\nâ¡ï¸ VUI LÃ’NG ÄÄ‚NG XUáº¤T VÃ€ ÄÄ‚NG NHáº¬P Láº I!');
            logout();
          } else if (errorData.error_code === 'COMPANY_MISMATCH' || errorData.force_logout) {
            alert('ğŸš¨ PHÃT HIá»†N THAY Äá»”I CÃ”NG TY!\n\n' + (errorData.message || 'CÃ´ng ty cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i trong há»‡ thá»‘ng.') + '\n\nâ¡ï¸ VUI LÃ’NG ÄÄ‚NG NHáº¬P Láº I Ä‘á»ƒ cáº­p nháº­t quyá»n truy cáº­p!');
            logout();
          } else {
            alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
            window.location.href = 'login.html';
          }
          return;
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to load candidates');
        }

        const data = await response.json();
        
        // Ensure we always get an array
        if (Array.isArray(data.data)) {
          allCandidates = data.data;
        } else if (Array.isArray(data)) {
          allCandidates = data;
        } else {
          console.warn('âš ï¸ Unexpected response format:', data);
          allCandidates = [];
        }
        
        filteredCandidates = [...allCandidates];
        
        renderTable();
        console.log('âœ… Loaded candidates:', allCandidates.length);
      } catch (error) {
        console.error('âŒ Error loading candidates:', error);
        allCandidates = [];
        filteredCandidates = [];
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="10" class="px-6 py-8 text-center text-red-600 font-medium">
              Lá»—i khi táº£i dá»¯ liá»‡u: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Update statistics - removed (no longer needed)

    // Render table
    function renderTable() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredCandidates.slice(start, end);

      if (pageData.length === 0) {
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="10" class="px-6 py-8 text-center text-gray-500">
              KhÃ´ng cÃ³ á»©ng viÃªn nÃ o
            </td>
          </tr>
        `;
        return;
      }

      const html = pageData.map(candidate => `
        <tr class="hover:bg-gray-50 transition">
          <td class="px-6 py-4 text-gray-900">${candidate.candidate_id}</td>
          <td class="px-6 py-4 font-semibold text-gray-900">${candidate.first_name} ${candidate.last_name}</td>
          <td class="px-6 py-4 text-indigo-600">${candidate.email}</td>
          <td class="px-6 py-4 text-gray-700">${candidate.phone || '-'}</td>
          <td class="px-6 py-4 text-gray-700">${candidate.position || candidate.current_position || '-'}</td>
          <td class="px-6 py-4 text-gray-700">${candidate.company_name || '-'}</td>
          <td class="px-6 py-4 text-gray-700">${candidate.experience_years || candidate.years_of_experience || 0} nÄƒm</td>
          <td class="px-6 py-4 text-gray-700">${getStatusText(candidate.status)}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${formatDate(candidate.created_at)}</td>
          <td class="px-6 py-4">
            <div class="flex justify-center gap-2 flex-wrap">
              <button onclick="viewCV(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #2563eb !important; color: white !important;" 
                title="Xem CV trong tab má»›i">
                Xem
              </button>
              <button onclick="downloadCV(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #4f46e5 !important; color: white !important;" 
                title="Táº£i CV vá» mÃ¡y">
                Táº£i
              </button>
              <button onclick="updateStatusPass(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #16a34a !important; color: white !important;" 
                title="Pass">
                Pass
              </button>
              <button onclick="updateStatusFail(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #dc2626 !important; color: white !important;" 
                title="Fail">
                Fail
              </button>
              <button onclick="editCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #eab308 !important; color: white !important;" 
                title="Sá»­a">
                Sá»­a
              </button>
              <button onclick="deleteCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 rounded transition text-sm shadow-sm font-medium" 
                style="background-color: #6b7280 !important; color: white !important;" 
                title="XÃ³a">
                XÃ³a
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      document.getElementById('candidatesTableBody').innerHTML = html;
      updatePagination();
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(filteredCandidates.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(start + itemsPerPage - 1, filteredCandidates.length);

      document.getElementById('showingFrom').textContent = filteredCandidates.length > 0 ? start : 0;
      document.getElementById('showingTo').textContent = end;
      document.getElementById('totalRecords').textContent = filteredCandidates.length;

      let buttonsHTML = '';
      
      if (currentPage > 1) {
        buttonsHTML += `<button onclick="goToPage(${currentPage - 1})" class="px-3 py-1 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded transition shadow-sm">â† TrÆ°á»›c</button>`;
      }

      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          buttonsHTML += `<button class="px-3 py-1 bg-indigo-600 text-white rounded font-semibold shadow-sm">${i}</button>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          buttonsHTML += `<button onclick="goToPage(${i})" class="px-3 py-1 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded transition shadow-sm">${i}</button>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          buttonsHTML += `<span class="px-2 text-gray-600">...</span>`;
        }
      }

      if (currentPage < totalPages) {
        buttonsHTML += `<button onclick="goToPage(${currentPage + 1})" class="px-3 py-1 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded transition shadow-sm">Sau â†’</button>`;
      }

      document.getElementById('paginationButtons').innerHTML = buttonsHTML;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    // Search candidates
    function searchCandidates() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      filteredCandidates = allCandidates.filter(candidate => {
        const matchesSearch = 
          candidate.first_name.toLowerCase().includes(searchTerm) ||
          candidate.last_name.toLowerCase().includes(searchTerm) ||
          candidate.email.toLowerCase().includes(searchTerm) ||
          (candidate.current_position && candidate.current_position.toLowerCase().includes(searchTerm)) ||
          (candidate.skills && candidate.skills.toLowerCase().includes(searchTerm));
        
        // Date filtering
        let matchesDate = true;
        if (fromDate || toDate) {
          const candidateDate = candidate.created_at ? new Date(candidate.created_at) : null;
          if (candidateDate) {
            if (fromDate) {
              const from = new Date(fromDate);
              from.setHours(0, 0, 0, 0);
              matchesDate = matchesDate && candidateDate >= from;
            }
            if (toDate) {
              const to = new Date(toDate);
              to.setHours(23, 59, 59, 999);
              matchesDate = matchesDate && candidateDate <= to;
            }
          } else {
            matchesDate = false;
          }
        }

        return matchesSearch && matchesDate;
      });

      currentPage = 1;
      renderTable();
    }

    // Filter by date
    function filterByDate() {
      searchCandidates();
    }

    // Refresh list
    function refreshList() {
      document.getElementById('searchInput').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      loadCandidates();
    }

    // Show add modal
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'ThÃªm á»¨ng ViÃªn Má»›i';
      document.getElementById('candidateId').value = '';
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('email').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('currentPosition').value = '';
      document.getElementById('yearsOfExperience').value = '';
      document.getElementById('education').value = '';
      document.getElementById('skills').value = '';
      document.getElementById('source').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('status').value = 'NEW';

      document.getElementById('candidateModal').classList.remove('hidden');
      document.getElementById('candidateModal').classList.add('flex');
    }

    // Close modal
    function closeModal() {
      document.getElementById('candidateModal').classList.add('hidden');
      document.getElementById('candidateModal').classList.remove('flex');
    }

    // View CV in new tab (inline display)
    function viewCV(id) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
        window.location.href = 'login.html';
        return;
      }
      
      // Open in new tab with token in Authorization header via fetch and blob
      const url = `${API_BASE_URL}/apply/candidates/${id}/cv`;
      
      fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('KhÃ´ng thá»ƒ táº£i CV');
        }
        return response.blob();
      })
      .then(blob => {
        // Create a blob URL and open in new tab
        const blobUrl = URL.createObjectURL(blob);
        window.open(blobUrl, '_blank');
        
        // Clean up the blob URL after some time
        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
      })
      .catch(error => {
        console.error('Error viewing CV:', error);
        alert('Lá»—i khi xem CV: ' + error.message);
      });
    }

    // Download CV to computer
    function downloadCV(id) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
        window.location.href = 'login.html';
        return;
      }
      
      const url = `${API_BASE_URL}/apply/candidates/${id}/cv/download`;
      
      fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('KhÃ´ng thá»ƒ táº£i CV');
        }
        
        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `CV_Candidate_${id}.pdf`;
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
          if (filenameMatch && filenameMatch[1]) {
            filename = filenameMatch[1];
          }
        }
        
        return response.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        // Create download link
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up
        setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
        
        console.log('âœ… CV downloaded successfully');
      })
      .catch(error => {
        console.error('Error downloading CV:', error);
        alert('Lá»—i khi táº£i CV: ' + error.message);
      });
    }

    // Update status to Pass (HIRED)
    async function updateStatusPass(id) {
      if (!confirm('XÃ¡c nháº­n PASS á»©ng viÃªn nÃ y? Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng táº¡o tÃ i khoáº£n vÃ  gá»­i email thÃ´ng bÃ¡o.')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/apply/candidates/${id}/status`, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify({ 
            status: 'HIRED',
            notes: 'PASS - ÄÃ£ duyá»‡t CV vÃ  táº¡o tÃ i khoáº£n'
          })
        });

        if (response.status === 401 || response.status === 403) {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to update status');
        }

        const data = await response.json();
        console.log('âœ… Response:', data);
        
        let message = data.message || 'Cáº­p nháº­t thÃ nh cÃ´ng!';
        if (data.data && data.data.email_sent) {
          message += '\nâœ… Email Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n: ' + data.data.email;
        }
        if (data.data && data.data.account_created && data.data.username) {
          message += '\nâœ… TÃ i khoáº£n Ä‘Ã£ táº¡o: ' + data.data.username;
        }
        
        alert(message);
        loadCandidates(); // Reload list
      } catch (error) {
        console.error('âŒ Error updating status:', error);
        alert('Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i: ' + error.message);
      }
    }

    // Update status to Fail (REJECTED)
    async function updateStatusFail(id) {
      if (!confirm('XÃ¡c nháº­n FAIL á»©ng viÃªn nÃ y? Há»‡ thá»‘ng sáº½ gá»­i email thÃ´ng bÃ¡o tá»« chá»‘i.')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/apply/candidates/${id}/status`, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify({ 
            status: 'REJECTED',
            notes: 'FAIL - KhÃ´ng Ä‘áº¡t yÃªu cáº§u'
          })
        });

        if (response.status === 401 || response.status === 403) {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to update status');
        }

        const data = await response.json();
        console.log('âœ… Response:', data);
        
        let message = data.message || 'Cáº­p nháº­t thÃ nh cÃ´ng!';
        if (data.data && data.data.email_sent) {
          message += '\nâœ… Email tá»« chá»‘i Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n: ' + data.data.email;
        }
        
        alert(message);
        loadCandidates(); // Reload list
      } catch (error) {
        console.error('âŒ Error updating status:', error);
        alert('Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i: ' + error.message);
      }
    }

    // View candidate
    function viewCandidate(id) {
      alert('Chi tiáº¿t á»©ng viÃªn ID: ' + id + '\n(Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn)');
    }

    // Edit candidate
    async function editCandidate(id) {
      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/apply/candidates/${id}`, {
          headers: headers
        });

        if (response.status === 401 || response.status === 403) {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) throw new Error('Failed to load candidate');

        const data = await response.json();
        const candidate = data.data;

        console.log('ğŸ“ Loading candidate for edit:', candidate);

        document.getElementById('modalTitle').textContent = 'Sá»­a ThÃ´ng Tin á»¨ng ViÃªn';
        document.getElementById('candidateId').value = candidate.candidate_id;
        document.getElementById('firstName').value = candidate.first_name || '';
        document.getElementById('lastName').value = candidate.last_name || '';
        document.getElementById('email').value = candidate.email || '';
        document.getElementById('phone').value = candidate.phone || '';
        document.getElementById('currentPosition').value = candidate.current_position || '';
        document.getElementById('yearsOfExperience').value = candidate.years_of_experience || '';
        document.getElementById('education').value = candidate.education || '';
        document.getElementById('skills').value = candidate.skills || '';
        document.getElementById('source').value = candidate.source || '';
        document.getElementById('notes').value = candidate.notes || '';
        document.getElementById('status').value = candidate.status || 'NEW';

        document.getElementById('candidateModal').classList.remove('hidden');
        document.getElementById('candidateModal').classList.add('flex');
      } catch (error) {
        console.error('âŒ Error loading candidate:', error);
        alert('Lá»—i khi táº£i thÃ´ng tin á»©ng viÃªn: ' + error.message);
      }
    }

    // Delete candidate
    async function deleteCandidate(id) {
      if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a á»©ng viÃªn nÃ y?')) return;

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        const response = await fetch(`${API_BASE_URL}/apply/candidates/${id}`, {
          method: 'DELETE',
          headers: headers
        });

        if (response.status === 401 || response.status === 403) {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) throw new Error('Failed to delete candidate');

        alert('âœ… ÄÃ£ xÃ³a á»©ng viÃªn thÃ nh cÃ´ng!');
        loadCandidates();
      } catch (error) {
        console.error('Error deleting candidate:', error);
        alert('âŒ Lá»—i khi xÃ³a á»©ng viÃªn: ' + error.message);
      }
    }

    // Real-time validation for email
    document.getElementById('email').addEventListener('input', function(e) {
      const email = e.target.value;
      const emailPattern = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
      
      if (email && !emailPattern.test(email)) {
        e.target.setCustomValidity('Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com (vÃ­ dá»¥: user123@gmail.com)');
        e.target.classList.add('border-red-500');
        e.target.classList.remove('border-gray-300');
      } else {
        e.target.setCustomValidity('');
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-gray-300');
      }
    });

    // Real-time validation for phone - only allow numbers
    document.getElementById('phone').addEventListener('input', function(e) {
      // Remove any non-digit characters
      let phone = e.target.value.replace(/\D/g, '');
      e.target.value = phone;
      
      const phonePattern = /^[0-9]{10,11}$/;
      
      if (phone && !phonePattern.test(phone)) {
        e.target.setCustomValidity('Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i tá»« 10-11 chá»¯ sá»‘');
        e.target.classList.add('border-red-500');
        e.target.classList.remove('border-gray-300');
      } else {
        e.target.setCustomValidity('');
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-gray-300');
      }
    });

    // Prevent non-numeric input on phone field
    document.getElementById('phone').addEventListener('keypress', function(e) {
      // Allow only numbers (0-9)
      if (e.key < '0' || e.key > '9') {
        e.preventDefault();
      }
    });

    // Handle form submit
    document.getElementById('candidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Final validation before submit
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      
      const emailPattern = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
      const phonePattern = /^[0-9]{10,11}$/;
      
      if (!emailPattern.test(email)) {
        alert('âŒ Email khÃ´ng há»£p lá»‡!\n\nEmail pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com\nVÃ­ dá»¥: user123@gmail.com');
        document.getElementById('email').focus();
        return;
      }
      
      if (!phonePattern.test(phone)) {
        alert('âŒ Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡!\n\nSá»‘ Ä‘iá»‡n thoáº¡i chá»‰ Ä‘Æ°á»£c nháº­p sá»‘, tá»« 10-11 chá»¯ sá»‘\nVÃ­ dá»¥: 0912345678');
        document.getElementById('phone').focus();
        return;
      }

      const candidateId = document.getElementById('candidateId').value;
      
      const candidateData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: email,
        phone: phone,
        current_position: document.getElementById('currentPosition').value,
        years_of_experience: document.getElementById('yearsOfExperience').value,
        education: document.getElementById('education').value,
        skills: document.getElementById('skills').value,
        source: document.getElementById('source').value,
        notes: document.getElementById('notes').value,
        status: document.getElementById('status').value
      };

      try {
        const headers = getAuthHeaders();
        if (!headers) return; // Already redirected to login
        
        let response;
        if (candidateId) {
          // Update existing candidate
          response = await fetch(`${API_BASE_URL}/apply/candidates/${candidateId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(candidateData)
          });
        } else {
          // Create new candidate
          response = await fetch(`${API_BASE_URL}/apply/candidates`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(candidateData)
          });
        }

        if (response.status === 401 || response.status === 403) {
          alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save candidate');
        }

        const result = await response.json();
        alert(candidateId ? 'âœ… ÄÃ£ cáº­p nháº­t thÃ´ng tin á»©ng viÃªn thÃ nh cÃ´ng!' : 'âœ… ÄÃ£ thÃªm á»©ng viÃªn má»›i thÃ nh cÃ´ng!');
        closeModal();
        loadCandidates();
      } catch (error) {
        console.error('Error saving candidate:', error);
        alert('âŒ Lá»—i: ' + error.message);
      }
    });

    // Clear any cached data on page load
    window.addEventListener('pageshow', function(event) {
      // If page is loaded from cache (back/forward button), force reload
      if (event.persisted) {
        console.log('ğŸ”„ Page loaded from cache, forcing reload...');
        window.location.reload();
      }
    });

    // Check if this is a fresh login (has timestamp in localStorage)
    const loginTimestamp = localStorage.getItem('login_timestamp');
    if (loginTimestamp) {
      const timeSinceLogin = Date.now() - parseInt(loginTimestamp);
      // If logged in less than 5 seconds ago, this is likely a fresh login
      if (timeSinceLogin < 5000) {
        console.log('ğŸ¯ Fresh login detected, ensuring no cache...');
        // Force reload to ensure fresh data
        if (!sessionStorage.getItem('reloaded_after_login')) {
          sessionStorage.setItem('reloaded_after_login', 'true');
          window.location.reload();
        } else {
          sessionStorage.removeItem('reloaded_after_login');
        }
      }
    }

    // Initialize
    if (checkAuth()) {
      loadCandidates();
    }

    // Setup theme toggle
    if (window.ThemeManager) {
      ThemeManager.setupToggle('themeToggle');
    }
  </script>

</body>
</html>
