<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh S√°ch ·ª®ng Vi√™n - Recruiter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-badge {
      @apply px-3 py-1 rounded-full text-xs font-semibold inline-block;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-800 via-indigo-900 to-slate-900 min-h-screen text-white">
  
  <!-- Header -->
  <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-indigo-400/30">
    <div class="max-w-7xl mx-auto flex justify-between items-center py-4 px-6">
      <div class="flex items-center gap-4">
        <a href="recruiter.html" class="text-2xl hover:text-indigo-300 transition">‚Üê</a>
        <h1 class="text-2xl md:text-3xl font-bold">üìã Qu·∫£n L√Ω ·ª®ng Vi√™n</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="userName" class="text-indigo-200">Xin ch√†o!</span>
        <button onclick="logout()" class="bg-gradient-to-r from-pink-500 to-purple-600 px-4 py-2 rounded-lg hover:opacity-90 transition">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto mt-6 p-6">
    
    <!-- Actions Bar -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between border border-white/20">
      <div class="flex gap-3 flex-wrap">
        <button onclick="showAddCandidateModal()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-lg transition flex items-center gap-2">
          <span>‚ûï</span>
          <span>Th√™m ·ª®ng Vi√™n</span>
        </button>
        <button onclick="refreshList()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg transition">
          üîÑ L√†m m·ªõi
        </button>
      </div>
      
      <!-- Search & Filter -->
      <div class="flex gap-3 flex-wrap flex-1 max-w-2xl">
        <input 
          id="searchInput" 
          type="text" 
          placeholder="üîç T√¨m theo t√™n, email, v·ªã tr√≠..." 
          class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          onkeyup="searchCandidates()"
        />
        <select 
          id="statusFilter" 
          onchange="filterByStatus()" 
          class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="NEW">M·ªõi</option>
          <option value="SCREENING">S√†ng l·ªçc</option>
          <option value="TESTING">ƒêang test</option>
          <option value="INTERVIEWING">Ph·ªèng v·∫•n</option>
          <option value="OFFERED">ƒê√£ offer</option>
          <option value="HIRED">ƒê√£ tuy·ªÉn</option>
          <option value="REJECTED">T·ª´ ch·ªëi</option>
        </select>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-emerald-600/20 border border-emerald-500/30 rounded-xl p-4">
        <div class="text-3xl font-bold" id="totalCandidates">0</div>
        <div class="text-sm text-emerald-200">T·ªïng ·ª©ng vi√™n</div>
      </div>
      <div class="bg-blue-600/20 border border-blue-500/30 rounded-xl p-4">
        <div class="text-3xl font-bold" id="newCandidates">0</div>
        <div class="text-sm text-blue-200">·ª®ng vi√™n m·ªõi</div>
      </div>
      <div class="bg-yellow-600/20 border border-yellow-500/30 rounded-xl p-4">
        <div class="text-3xl font-bold" id="testingCandidates">0</div>
        <div class="text-sm text-yellow-200">ƒêang test</div>
      </div>
      <div class="bg-green-600/20 border border-green-500/30 rounded-xl p-4">
        <div class="text-3xl font-bold" id="hiredCandidates">0</div>
        <div class="text-sm text-green-200">ƒê√£ tuy·ªÉn</div>
      </div>
    </div>

    <!-- Candidates Table -->
    <div class="bg-white/10 backdrop-blur-md rounded-xl overflow-hidden border border-white/20">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-white/10">
            <tr>
              <th class="px-6 py-4 text-left font-semibold">ID</th>
              <th class="px-6 py-4 text-left font-semibold">H·ªç t√™n</th>
              <th class="px-6 py-4 text-left font-semibold">Email</th>
              <th class="px-6 py-4 text-left font-semibold">S·ªë ƒëi·ªán tho·∫°i</th>
              <th class="px-6 py-4 text-left font-semibold">V·ªã tr√≠</th>
              <th class="px-6 py-4 text-left font-semibold">Kinh nghi·ªám</th>
              <th class="px-6 py-4 text-left font-semibold">Tr·∫°ng th√°i</th>
              <th class="px-6 py-4 text-left font-semibold">Ng√†y t·∫°o</th>
              <th class="px-6 py-4 text-center font-semibold">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="candidatesTableBody" class="divide-y divide-white/10">
            <tr>
              <td colspan="9" class="px-6 py-8 text-center text-gray-400">
                ƒêang t·∫£i d·ªØ li·ªáu...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div id="paginationContainer" class="bg-white/5 px-6 py-4 flex justify-between items-center border-t border-white/10">
        <div class="text-sm text-gray-300">
          Hi·ªÉn th·ªã <span id="showingFrom">0</span> - <span id="showingTo">0</span> c·ªßa <span id="totalRecords">0</span> b·∫£n ghi
        </div>
        <div id="paginationButtons" class="flex gap-2">
          <!-- Pagination buttons will be inserted here -->
        </div>
      </div>
    </div>

  </main>

  <!-- Add/Edit Candidate Modal -->
  <div id="candidateModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-slate-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-indigo-400/30 shadow-2xl">
      <div class="sticky top-0 bg-slate-800 border-b border-white/10 px-6 py-4 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-bold">Th√™m ·ª®ng Vi√™n M·ªõi</h2>
        <button onclick="closeModal()" class="text-3xl hover:text-red-400 transition">&times;</button>
      </div>
      
      <form id="candidateForm" class="p-6 space-y-4">
        <input type="hidden" id="candidateId" />
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">H·ªç *</label>
            <input type="text" id="firstName" required 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">T√™n *</label>
            <input type="text" id="lastName" required 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Email *</label>
          <input type="email" id="email" required 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="tel" id="phone" 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">V·ªã tr√≠ hi·ªán t·∫°i</label>
            <input type="text" id="currentPosition" 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">S·ªë nƒÉm kinh nghi·ªám</label>
            <input type="number" id="yearsOfExperience" min="0" 
              class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">H·ªçc v·∫•n</label>
          <textarea id="education" rows="2" 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">K·ªπ nƒÉng (ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y)</label>
          <textarea id="skills" rows="2" placeholder="JavaScript, React, Node.js"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Ngu·ªìn ·ª©ng tuy·ªÉn *</label>
          <select id="source" required
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            <option value="">Ch·ªçn ngu·ªìn</option>
            <option value="Facebook">Facebook</option>
            <option value="TikTok">TikTok</option>
            <option value="Workshop">Workshop</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="Website">Website</option>
            <option value="Referral">Gi·ªõi thi·ªáu</option>
            <option value="Other">Kh√°c</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Upload CV/Resume (PDF)</label>
          <input type="file" id="resumeFile" accept=".pdf" 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 file:cursor-pointer" />
          <p class="text-xs text-gray-400 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file PDF, t·ªëi ƒëa 5MB</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Ghi ch√∫</label>
          <textarea id="notes" rows="3" 
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
        </div>
        
        <div class="text-sm text-yellow-300 bg-yellow-900/20 p-3 rounded-lg border border-yellow-600/30">
          ‚ÑπÔ∏è Tr·∫°ng th√°i s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ƒë·∫∑t l√† <strong>"M·ªõi"</strong> khi th√™m ·ª©ng vi√™n
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 px-6 py-3 rounded-lg font-semibold transition">
            üíæ L∆∞u
          </button>
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-lg font-semibold transition">
            H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let allCandidates = [];
    let filteredCandidates = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('auth_token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    // Check authentication
    function checkAuth() {
      const session = JSON.parse(localStorage.getItem('session_user') || 'null');
      const token = localStorage.getItem('auth_token');
      
      if (!session || !token) {
        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
        window.location.href = 'index.html';
        return false;
      }

      const role = String(session.role || '').toUpperCase();
      if (role !== 'RECRUITER' && role !== 'ADMIN') {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
        window.location.href = 'exam.html';
        return false;
      }

      // Display user name
      document.getElementById('userName').textContent = `Xin ch√†o, ${session.fullName || session.username}!`;
      return true;
    }

    // Logout
    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('session_user');
      window.location.href = 'index.html';
    }

    // Get status badge HTML
    function getStatusBadge(status) {
      const statusConfig = {
        'NEW': { color: 'bg-blue-500/80', text: 'M·ªõi' },
        'SCREENING': { color: 'bg-yellow-500/80', text: 'S√†ng l·ªçc' },
        'TESTING': { color: 'bg-purple-500/80', text: 'ƒêang test' },
        'INTERVIEWING': { color: 'bg-indigo-500/80', text: 'Ph·ªèng v·∫•n' },
        'OFFERED': { color: 'bg-orange-500/80', text: 'ƒê√£ offer' },
        'HIRED': { color: 'bg-green-500/80', text: 'ƒê√£ tuy·ªÉn' },
        'REJECTED': { color: 'bg-red-500/80', text: 'T·ª´ ch·ªëi' }
      };
      
      const config = statusConfig[status] || { color: 'bg-gray-500/80', text: status };
      return `<span class="status-badge ${config.color}">${config.text}</span>`;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
      });
    }

    // Load all candidates
    async function loadCandidates() {
      try {
        const response = await fetch(`${API_BASE_URL}/candidates`, {
          headers: getAuthHeaders()
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to load candidates');
        }

        const data = await response.json();
        
        // Ensure we always get an array
        if (Array.isArray(data.data)) {
          allCandidates = data.data;
        } else if (Array.isArray(data)) {
          allCandidates = data;
        } else {
          console.warn('‚ö†Ô∏è Unexpected response format:', data);
          allCandidates = [];
        }
        
        filteredCandidates = [...allCandidates];
        
        updateStatistics();
        renderTable();
        console.log('‚úÖ Loaded candidates:', allCandidates.length);
      } catch (error) {
        console.error('‚ùå Error loading candidates:', error);
        allCandidates = [];
        filteredCandidates = [];
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-red-400">
              L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Update statistics
    function updateStatistics() {
      document.getElementById('totalCandidates').textContent = allCandidates.length;
      document.getElementById('newCandidates').textContent = allCandidates.filter(c => c.status === 'NEW').length;
      document.getElementById('testingCandidates').textContent = allCandidates.filter(c => c.status === 'TESTING').length;
      document.getElementById('hiredCandidates').textContent = allCandidates.filter(c => c.status === 'HIRED').length;
    }

    // Render table
    function renderTable() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredCandidates.slice(start, end);

      if (pageData.length === 0) {
        document.getElementById('candidatesTableBody').innerHTML = `
          <tr>
            <td colspan="9" class="px-6 py-8 text-center text-gray-400">
              Kh√¥ng c√≥ ·ª©ng vi√™n n√†o
            </td>
          </tr>
        `;
        return;
      }

      const html = pageData.map(candidate => `
        <tr class="hover:bg-white/5 transition">
          <td class="px-6 py-4">${candidate.candidate_id}</td>
          <td class="px-6 py-4 font-semibold">${candidate.first_name} ${candidate.last_name}</td>
          <td class="px-6 py-4 text-indigo-300">${candidate.email}</td>
          <td class="px-6 py-4">${candidate.phone || '-'}</td>
          <td class="px-6 py-4">${candidate.current_position || '-'}</td>
          <td class="px-6 py-4">${candidate.years_of_experience || 0} nƒÉm</td>
          <td class="px-6 py-4">${getStatusBadge(candidate.status)}</td>
          <td class="px-6 py-4 text-sm text-gray-300">${formatDate(candidate.created_at)}</td>
          <td class="px-6 py-4">
            <div class="flex justify-center gap-2">
              <button onclick="viewCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded transition text-sm" title="Xem chi ti·∫øt">
                üëÅÔ∏è
              </button>
              <button onclick="editCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 bg-yellow-600 hover:bg-yellow-500 rounded transition text-sm" title="S·ª≠a">
                ‚úèÔ∏è
              </button>
              <button onclick="deleteCandidate(${candidate.candidate_id})" 
                class="px-3 py-1 bg-red-600 hover:bg-red-500 rounded transition text-sm" title="X√≥a">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      document.getElementById('candidatesTableBody').innerHTML = html;
      updatePagination();
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(filteredCandidates.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(start + itemsPerPage - 1, filteredCandidates.length);

      document.getElementById('showingFrom').textContent = filteredCandidates.length > 0 ? start : 0;
      document.getElementById('showingTo').textContent = end;
      document.getElementById('totalRecords').textContent = filteredCandidates.length;

      let buttonsHTML = '';
      
      if (currentPage > 1) {
        buttonsHTML += `<button onclick="goToPage(${currentPage - 1})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">‚Üê Tr∆∞·ªõc</button>`;
      }

      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          buttonsHTML += `<button class="px-3 py-1 bg-indigo-600 rounded font-semibold">${i}</button>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          buttonsHTML += `<button onclick="goToPage(${i})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">${i}</button>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          buttonsHTML += `<span class="px-2">...</span>`;
        }
      }

      if (currentPage < totalPages) {
        buttonsHTML += `<button onclick="goToPage(${currentPage + 1})" class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded transition">Sau ‚Üí</button>`;
      }

      document.getElementById('paginationButtons').innerHTML = buttonsHTML;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    // Search candidates
    function searchCandidates() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      filteredCandidates = allCandidates.filter(candidate => {
        const matchesSearch = 
          candidate.first_name.toLowerCase().includes(searchTerm) ||
          candidate.last_name.toLowerCase().includes(searchTerm) ||
          candidate.email.toLowerCase().includes(searchTerm) ||
          (candidate.current_position && candidate.current_position.toLowerCase().includes(searchTerm)) ||
          (candidate.skills && candidate.skills.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || candidate.status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      currentPage = 1;
      renderTable();
    }

    // Filter by status
    function filterByStatus() {
      searchCandidates();
    }

    // Refresh list
    function refreshList() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      loadCandidates();
    }

    // Show add modal
    function showAddCandidateModal() {
      document.getElementById('modalTitle').textContent = 'Th√™m ·ª®ng Vi√™n M·ªõi';
      document.getElementById('candidateForm').reset();
      document.getElementById('candidateId').value = '';
      document.getElementById('candidateModal').classList.remove('hidden');
      document.getElementById('candidateModal').classList.add('flex');
    }

    // Close modal
    function closeModal() {
      document.getElementById('candidateModal').classList.add('hidden');
      document.getElementById('candidateModal').classList.remove('flex');
    }

    // View candidate
    function viewCandidate(id) {
      alert('Chi ti·∫øt ·ª©ng vi√™n ID: ' + id + '\n(Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn)');
    }

    // Edit candidate
    async function editCandidate(id) {
      try {
        const response = await fetch(`${API_BASE_URL}/candidates/${id}`, {
          headers: getAuthHeaders()
        });

        if (!response.ok) throw new Error('Failed to load candidate');

        const data = await response.json();
        const candidate = data.data;

        document.getElementById('modalTitle').textContent = 'S·ª≠a Th√¥ng Tin ·ª®ng Vi√™n';
        document.getElementById('candidateId').value = candidate.candidate_id;
        document.getElementById('firstName').value = candidate.first_name;
        document.getElementById('lastName').value = candidate.last_name;
        document.getElementById('email').value = candidate.email;
        document.getElementById('phone').value = candidate.phone || '';
        document.getElementById('currentPosition').value = candidate.current_position || '';
        document.getElementById('yearsOfExperience').value = candidate.years_of_experience || '';
        document.getElementById('education').value = candidate.education || '';
        document.getElementById('skills').value = candidate.skills || '';
        document.getElementById('source').value = candidate.source || '';
        document.getElementById('status').value = candidate.status;
        document.getElementById('notes').value = candidate.notes || '';

        document.getElementById('candidateModal').classList.remove('hidden');
        document.getElementById('candidateModal').classList.add('flex');
      } catch (error) {
        console.error('Error loading candidate:', error);
        alert('L·ªói khi t·∫£i th√¥ng tin ·ª©ng vi√™n');
      }
    }

    // Delete candidate
    async function deleteCandidate(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·ª©ng vi√™n n√†y?')) return;

      try {
        const response = await fetch(`${API_BASE_URL}/candidates/${id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (!response.ok) throw new Error('Failed to delete candidate');

        alert('‚úÖ ƒê√£ x√≥a ·ª©ng vi√™n th√†nh c√¥ng!');
        loadCandidates();
      } catch (error) {
        console.error('Error deleting candidate:', error);
        alert('‚ùå L·ªói khi x√≥a ·ª©ng vi√™n: ' + error.message);
      }
    }

    // Handle form submit
    document.getElementById('candidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const candidateId = document.getElementById('candidateId').value;
      const resumeFile = document.getElementById('resumeFile').files[0];

      // Validate file if provided
      if (resumeFile) {
        if (resumeFile.type !== 'application/pdf') {
          alert('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file PDF!');
          return;
        }
        if (resumeFile.size > 5 * 1024 * 1024) { // 5MB
          alert('‚ùå File kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!');
          return;
        }
      }

      try {
        let response;
        if (candidateId) {
          // Update - JSON only (no file upload on update for now)
          const candidateData = {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            current_position: document.getElementById('currentPosition').value,
            years_of_experience: parseInt(document.getElementById('yearsOfExperience').value) || null,
            education: document.getElementById('education').value,
            skills: document.getElementById('skills').value,
            source: document.getElementById('source').value,
            notes: document.getElementById('notes').value
          };

          response = await fetch(`${API_BASE_URL}/candidates/${candidateId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(candidateData)
          });
        } else {
          // Create - Use FormData for file upload
          const formData = new FormData();
          formData.append('first_name', document.getElementById('firstName').value);
          formData.append('last_name', document.getElementById('lastName').value);
          formData.append('email', document.getElementById('email').value);
          formData.append('phone', document.getElementById('phone').value || '');
          formData.append('current_position', document.getElementById('currentPosition').value || '');
          formData.append('years_of_experience', document.getElementById('yearsOfExperience').value || '');
          formData.append('education', document.getElementById('education').value || '');
          formData.append('skills', document.getElementById('skills').value || '');
          formData.append('source', document.getElementById('source').value);
          formData.append('status', 'NEW'); // Always NEW for new candidates
          formData.append('notes', document.getElementById('notes').value || '');
          
          if (resumeFile) {
            formData.append('resume', resumeFile);
          }

          const token = localStorage.getItem('auth_token');
          response = await fetch(`${API_BASE_URL}/candidates`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
              // Don't set Content-Type, browser will set it with boundary for FormData
            },
            body: formData
          });
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save candidate');
        }

        const result = await response.json();
        alert(candidateId ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!' : `‚úÖ ƒê√£ th√™m ·ª©ng vi√™n th√†nh c√¥ng!${resumeFile ? '\nüìÑ CV ƒë√£ ƒë∆∞·ª£c upload' : ''}`);
        closeModal();
        loadCandidates();
      } catch (error) {
        console.error('Error saving candidate:', error);
        alert('‚ùå L·ªói: ' + error.message);
      }
    });

    // Initialize
    if (checkAuth()) {
      loadCandidates();
    }
  </script>

</body>
</html>
