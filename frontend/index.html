<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đăng nhập - Hệ thống thi</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>

<body class="fade-enter">
  <main class="auth-page">
    <section class="auth-card">
      <!-- Cột trái -->
      <div class="left">
        <h1>Đăng nhập</h1>
        <p class="muted">Đăng nhập bằng khuôn mặt hoặc tài khoản để vào phòng thi</p>

        <!-- camera -->
        <div class="cam-wrap">
          <video id="loginCam" autoplay playsinline muted></video>
          <div class="cam-overlay">Camera</div>
        </div>

        <!-- Hành động -->
        <div class="actions">
          <button id="faceBtn" class="btn primary">Quét khuôn mặt &amp; Đăng nhập</button>
          <div class="or">hoặc</div>

          <input id="userInput" placeholder="Tên đăng nhập hoặc Email" class="input" />
          <input id="pwInput" placeholder="Mật khẩu" type="password" class="input" />

          <button id="loginBtn" class="btn ghost">Đăng nhập</button>

          <p class="note">
            Chưa có tài khoản? 
            <a href="register.html" style="color: var(--neon2); text-decoration: none; font-weight: 600;">Đăng ký</a>
          </p>
        </div>
      </div>

      <!-- Cột phải -->
      <div class="right">
        <div class="panel">
          <h3>Hướng dẫn nhanh</h3>
          <ol>
            <li>Cho phép truy cập camera.</li>
            <li>Nhấn <strong>"Quét khuôn mặt"</strong> để đăng nhập nhanh.</li>
            <li>Hoặc đăng nhập bằng tài khoản bên dưới.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Nếu đã đăng nhập trước đó thì chuyển trang theo vai trò
    (function autoRedirectIfLoggedIn() {
      try {
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        if (session && session.role) {
          const role = String(session.role).toUpperCase();
          if (role === 'RECRUITER') {
            location.replace('recruiter.html');
            return;
          }
          if (role === 'CANDIDATE') {
            location.replace('exam.html');
            return;
          }
        }
      } catch (_) {}
    })();

    const loginCam = document.getElementById('loginCam');
    const camWrap = document.querySelector('.cam-wrap');
    camWrap.style.display = 'none'; // Ẩn camera ban đầu

    // bấm quét khuôn mặt bật camera
    document.getElementById('faceBtn').addEventListener('click', async () => {
      camWrap.style.display = 'block';
      try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        loginCam.srcObject = s;
      } catch (e) {
        alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập!');
        console.warn(e);
        return;
      }

      // Lưu ảnh demo (giả lập sinh faceID)
      const c = document.createElement('canvas');
      c.width = loginCam.videoWidth || 640;
      c.height = loginCam.videoHeight || 480;
      const ctx = c.getContext('2d');
      ctx.drawImage(loginCam, 0, 0, c.width, c.height);
      const data = c.toDataURL('image/jpeg', 0.7);
      const id = 'face-' + Math.abs([...data].reduce((a, b) => ((a << 5) - a) + b.charCodeAt(0), 0));

      localStorage.setItem('session_user', JSON.stringify({
        name: 'face-user',
        faceID: id,
        loginAt: Date.now()
      }));

      // Hiệu ứng chuyển trang
      document.body.classList.remove('fade-enter');
      document.body.classList.add('fade-exit');
      setTimeout(() => location.href = 'exam.html', 350);
    });

    // Đăng nhập thủ công - Kết nối với backend API
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const userInput = document.getElementById('userInput').value.trim();
      const password = document.getElementById('pwInput').value;

      if (!userInput || !password) {
        alert('Vui lòng nhập tên đăng nhập và mật khẩu!');
        return;
      }

      try {
        // Xác định là email hay username
        const isEmail = userInput.includes('@');
        const loginData = {
          password,
          [isEmail ? 'email' : 'username']: userInput
        };

        // Gọi API login từ backend
        const response = await apiCall('/auth/login', {
          method: 'POST',
          body: JSON.stringify(loginData)
        });

        // Backend trả về response.data.user và response.data.token
        const userData = response.data || response;
        const token = userData.token;
        const user = userData.user;

        // Lưu token và thông tin user
        localStorage.setItem('auth_token', token);
        localStorage.setItem('session_user', JSON.stringify({
          name: user.username || user.fullName || userInput,
          role: user.role,
          userId: user.id,
          email: user.email,
          loginAt: Date.now()
        }));

        // Chuyển trang theo vai trò
        document.body.classList.remove('fade-enter');
        document.body.classList.add('fade-exit');
        const role = String(user.role || '').toUpperCase();
        setTimeout(() => {
          if (role === 'RECRUITER') {
            location.href = 'recruiter.html';
          } else {
            location.href = 'exam.html';
          }
        }, 350);
      } catch (error) {
        alert('Đăng nhập thất bại: ' + error.message);
        console.error('Login error:', error);
      }
    });
  </script>
</body>
</html>
