<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đăng nhập - Hệ thống thi</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>

<body class="fade-enter">
  <main class="auth-page">
    <section class="auth-card">
      <!-- Cột trái -->
      <div class="left">
        <h1>Đăng nhập</h1>
        <p class="muted">Tạo tài khoản và lưu ảnh khuôn mặt để đăng nhập nhanh</p>

        <!-- Hành động -->
        <div class="actions">
          <input id="userInput" placeholder="Tên đăng nhập hoặc Email" class="input" />
          <input id="pwInput" placeholder="Mật khẩu" type="password" class="input" />

          <button id="loginBtn" class="btn primary">Đăng nhập</button>

          <p class="note">
            Chưa có tài khoản? 
            <a href="register.html" style="color: var(--neon2); text-decoration: none; font-weight: 600;">Đăng ký</a>
          </p>
          
          <p class="note" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
            Ứng tuyển công việc? 
            <a href="apply.html" style="color: #10b981; text-decoration: none; font-weight: 600;">Nộp CV ngay →</a>
          </p>
        </div>
      </div>

      <!-- Cột phải -->
      <div class="right">
        <div class="panel">
          <h3>Hướng dẫn nhanh</h3>
          <p class="muted">Nhập tên đăng nhập hoặc email và mật khẩu để truy cập hệ thống.</p>
          <p class="muted" style="margin-top: 12px;">Tài khoản demo:<br/>
            <strong>recruiter@cs60.com</strong> / 123456 (Recruiter)<br/>
            <strong>havy@test.com</strong> / 123456 (Candidate)
          </p>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Nếu đã đăng nhập trước đó thì chuyển trang theo vai trò
    (function autoRedirectIfLoggedIn() {
      try {
        const session = JSON.parse(localStorage.getItem('session_user') || 'null');
        if (session && session.role) {
          const role = String(session.role).toUpperCase();
          if (role === 'RECRUITER') {
            location.replace('recruiter.html');
            return;
          }
          if (role === 'CANDIDATE') {
            location.replace('exam.html');
            return;
          }
        }
      } catch (_) {}
    })();

    // Removed face recognition login

    // Đăng nhập thủ công - Kết nối với backend API
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const userInput = document.getElementById('userInput').value.trim();
      const password = document.getElementById('pwInput').value;

      if (!userInput || !password) {
        alert('Vui lòng nhập tên đăng nhập và mật khẩu!');
        return;
      }

      try {
        // Xác định là email hay username
        const isEmail = userInput.includes('@');
        const loginData = {
          password,
          [isEmail ? 'email' : 'username']: userInput
        };

        // Gọi API login từ backend
        const response = await apiCall('/auth/login', {
          method: 'POST',
          body: JSON.stringify(loginData)
        });

        // Backend trả về response.data.user và response.data.token
        const userData = response.data || response;
        const token = userData.token;
        const user = userData.user;

        // Lưu token và thông tin user - CHỈ DÙNG userId (chuẩn hóa)
        localStorage.setItem('auth_token', token);
        localStorage.setItem('session_user', JSON.stringify({
          userId: user.userId,  // CHỈ dùng userId duy nhất
          username: user.username,
          fullName: user.fullName,
          email: user.email,
          role: user.role,
          loginAt: Date.now()
        }));
        
        console.log('✅ User logged in:', user.userId, user.role);

        // Chuyển trang theo vai trò
        document.body.classList.remove('fade-enter');
        document.body.classList.add('fade-exit');
        const role = String(user.role || '').toUpperCase();
        setTimeout(() => {
          if (role === 'RECRUITER') {
            location.href = 'recruiter.html';
          } else {
            location.href = 'exam.html';
          }
        }, 350);
      } catch (error) {
        alert('Đăng nhập thất bại: ' + error.message);
        console.error('Login error:', error);
      }
    });
  </script>
</body>
</html>
