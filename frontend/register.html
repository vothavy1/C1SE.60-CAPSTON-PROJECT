<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÄÄƒng kÃ½ - Há»‡ thá»‘ng thi</title>
<link rel="stylesheet" href="style.css">
<script src="config.js"></script>
</head>
<body class="fade-enter">
<main class="auth-page">
<section class="auth-card">
<div class="left">
<h1>ÄÄƒng kÃ½</h1>
<p class="muted">ÄÄƒng kÃ½ tÃ i khoáº£n Recruiter Ä‘á»ƒ quáº£n lÃ½ Ä‘á» thi vÃ  á»©ng viÃªn</p>

<!-- ThÃ´ng bÃ¡o cho á»©ng viÃªn -->
<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 14px 18px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #34d399;">
  <div style="display: flex; align-items: center; gap: 10px;">
    <span style="font-size: 20px;">ğŸ‘¥</span>
    <div style="flex: 1;">
      <div style="font-weight: 600; color: white; margin-bottom: 4px;">Báº¡n lÃ  á»©ng viÃªn?</div>
      <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
        á»¨ng viÃªn khÃ´ng cáº§n Ä‘Äƒng kÃ½ tÃ i khoáº£n. HÃ£y ná»™p CV trá»±c tiáº¿p!
      </div>
      <a href="apply.html" style="display: inline-block; background: white; color: #059669; padding: 6px 16px; border-radius: 6px; font-weight: 600; text-decoration: none; font-size: 13px; transition: all 0.2s;">
        ğŸ“„ Ná»™p CV ngay â†’
      </a>
    </div>
  </div>
</div>

<input id="fullName" class="input" placeholder="Há» vÃ  tÃªn" />
<input id="email" class="input" type="email" 
  pattern="[a-zA-Z0-9._%+-]+@gmail\.com$"
  title="Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com (vÃ­ dá»¥: user123@gmail.com)"
  placeholder="example123@gmail.com" />
<small style="color: #9aa6bf; font-size: 12px; margin-top: -8px; display: block;">Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com</small>
<input id="pwd" type="password" class="input" placeholder="Máº­t kháº©u" />

<!-- Vai trÃ² cá»‘ Ä‘á»‹nh lÃ  Recruiter -->
<input type="hidden" name="role" id="roleRecruiter" value="recruiter" />

<!-- Chá»n cÃ´ng ty -->
<div id="companySection" style="display:none; margin-bottom:12px;">
  <div style="margin: 10px 0 4px; color: var(--muted); font-size: 14px;">CÃ´ng ty <span style="color:red;">*</span></div>
  <select id="companySelect" class="input" style="padding: 12px; color: #fff; background-color: rgba(255,255,255,0.1);">
    <option value="" style="color: #333; background-color: #fff;">-- Chá»n cÃ´ng ty --</option>
  </select>
</div>

<!-- Input tÃªn cÃ´ng ty má»›i (hiá»‡n khi chá»n "CÃ´ng ty khÃ¡c") -->
<div id="otherCompanySection" style="display:none; margin-bottom:12px;">
  <div style="margin: 10px 0 4px; color: var(--muted); font-size: 14px;">TÃªn cÃ´ng ty má»›i <span style="color:red;">*</span></div>
  <input id="otherCompanyInput" class="input" placeholder="Nháº­p tÃªn cÃ´ng ty cá»§a báº¡n" />
  <div style="font-size: 12px; color: #fbbf24; margin-top: 6px; display: flex; gap: 6px; align-items: start;">
    <span>âš ï¸</span>
    <span>Admin sáº½ nháº­n thÃ´ng bÃ¡o vÃ  thÃªm cÃ´ng ty nÃ y vÃ o há»‡ thá»‘ng. Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p sau khi admin phÃª duyá»‡t.</span>
  </div>
</div>

<div class="actions">
<button id="registerSubmit" class="btn primary">HoÃ n táº¥t Ä‘Äƒng kÃ½</button>
<p class="note">ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="index.html">ÄÄƒng nháº­p</a></p>
<p class="note" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
  Chá»‰ muá»‘n á»©ng tuyá»ƒn? <a href="apply.html" style="color: #10b981;">Ná»™p CV â†’</a>
</p>
</div>
</div>


<div class="right">
<div class="panel">
<h3>ÄÄƒng kÃ½ Recruiter</h3>
<p class="muted">Trang nÃ y dÃ nh cho nhÃ  tuyá»ƒn dá»¥ng Ä‘Äƒng kÃ½ tÃ i khoáº£n Ä‘á»ƒ quáº£n lÃ½ há»‡ thá»‘ng. Vui lÃ²ng chá»n cÃ´ng ty báº¡n lÃ m viá»‡c hoáº·c yÃªu cáº§u admin thÃªm cÃ´ng ty má»›i.</p>
</div>
</div>
</section>
</main>


<script>
// Removed face recognition code

// Load companies from API
async function loadCompanies() {
  try {
    console.log('Loading companies...');
    const response = await apiCall('/companies', {
      method: 'GET'
    });
    
    console.log('Companies loaded:', response);
    
    const companySelect = document.getElementById('companySelect');
    if (!companySelect) {
      console.error('companySelect element not found!');
      return;
    }
    
    companySelect.innerHTML = '<option value="">-- Chá»n cÃ´ng ty --</option>';
    
    if (response.data && Array.isArray(response.data)) {
      response.data.forEach(company => {
        const option = document.createElement('option');
        option.value = company.company_id;
        option.textContent = company.company_name || company.companyName;
        option.style.color = '#333';
        option.style.backgroundColor = '#fff';
        companySelect.appendChild(option);
      });
    }
    
    // ThÃªm option "CÃ´ng ty khÃ¡c"
    const otherOption = document.createElement('option');
    otherOption.value = 'OTHER';
    otherOption.textContent = 'ğŸ¢ CÃ´ng ty khÃ¡c (YÃªu cáº§u admin thÃªm)';
    otherOption.style.color = '#059669';
    otherOption.style.backgroundColor = '#f0fdf4';
    otherOption.style.fontWeight = '600';
    companySelect.appendChild(otherOption);
    
    console.log('Companies dropdown populated');
  } catch (error) {
    console.error('Error loading companies:', error);
    alert('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch cÃ´ng ty. Vui lÃ²ng thá»­ láº¡i sau.');
  }
}

// Show input field when "Other company" is selected
document.addEventListener('DOMContentLoaded', () => {
  const companySelect = document.getElementById('companySelect');
  const otherCompanySection = document.getElementById('otherCompanySection');
  
  if (companySelect && otherCompanySection) {
    companySelect.addEventListener('change', (e) => {
      if (e.target.value === 'OTHER') {
        otherCompanySection.style.display = 'block';
      } else {
        otherCompanySection.style.display = 'none';
      }
    });
  }
  
  // Always show company section for recruiter registration
  document.getElementById('companySection').style.display = 'block';
  loadCompanies();
});

// Real-time validation for email
document.getElementById('email').addEventListener('input', function(e) {
  const email = e.target.value;
  const emailPattern = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
  
  if (email && !emailPattern.test(email)) {
    e.target.setCustomValidity('Email pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com (vÃ­ dá»¥: user123@gmail.com)');
    e.target.style.borderColor = '#ef4444';
  } else {
    e.target.setCustomValidity('');
    e.target.style.borderColor = 'rgba(255,255,255,0.06)';
  }
});

// NÃºt hoÃ n táº¥t Ä‘Äƒng kÃ½ - Káº¿t ná»‘i backend API
document.getElementById('registerSubmit').addEventListener('click', async () => {
  const full_name = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('pwd').value;

  if (!full_name || !email || !password) {
    alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
    return;
  }

  // Final validation before submit
  const emailPattern = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
  
  if (!emailPattern.test(email)) {
    alert('âŒ Email khÃ´ng há»£p lá»‡!\n\nEmail pháº£i cÃ³ dáº¡ng: chá»¯ vÃ  sá»‘ @gmail.com\nVÃ­ dá»¥: user123@gmail.com');
    document.getElementById('email').focus();
    return;
  }

  // Táº¡o username tá»« email (pháº§n trÆ°á»›c @)
  const username = email.split('@')[0];

  try {
    // Cá»‘ Ä‘á»‹nh role_id = 2 (Recruiter)
    const role_id = 2;
    
    // Check company selection for recruiters
    let company_id = null;
    let other_company_name = null;
    
    const selectedCompany = document.getElementById('companySelect').value;
    if (!selectedCompany) {
      alert('Vui lÃ²ng chá»n cÃ´ng ty!');
      return;
    }
    
    if (selectedCompany === 'OTHER') {
      // Recruiter chá»n "CÃ´ng ty khÃ¡c"
      other_company_name = document.getElementById('otherCompanyInput').value.trim();
      if (!other_company_name) {
        alert('Vui lÃ²ng nháº­p tÃªn cÃ´ng ty!');
        return;
      }
      company_id = null; // KhÃ´ng cÃ³ company_id
    } else {
      // Chá»n cÃ´ng ty cÃ³ sáºµn
      company_id = selectedCompany;
    }

    // Gá»i API register
    const requestBody = {
      username,
      email,
      password,
      full_name,
      role_id
    };
    
    // ThÃªm company_id hoáº·c other_company_name
    if (other_company_name) {
      requestBody.other_company_name = other_company_name;
      // KHÃ”NG gá»­i company_id
      console.log('Sending with other_company_name:', other_company_name);
    } else {
      requestBody.company_id = company_id;
      console.log('Sending with company_id:', company_id);
    }
    
    console.log('Request body:', requestBody);
    
    const response = await apiCall('/auth/register', {
      method: 'POST',
      body: JSON.stringify(requestBody)
    });

    if (other_company_name) {
      alert('âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng!\n\nâš ï¸ TÃ i khoáº£n cá»§a báº¡n Ä‘ang chá» admin thÃªm cÃ´ng ty "' + other_company_name + '" vÃ o há»‡ thá»‘ng.\n\nBáº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p sau khi admin phÃª duyá»‡t.');
    } else {
      alert('ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vá» trang Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c.');
    }
    
    document.body.classList.remove('fade-enter');
    document.body.classList.add('fade-exit');
    setTimeout(() => location.href = 'index.html', 350);
  } catch (error) {
    alert('ÄÄƒng kÃ½ tháº¥t báº¡i: ' + error.message);
    console.error('Register error:', error);
  }
});
</script>
</body>
</html>