<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Exam Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üêõ Debug: T·∫°i sao exam.html kh√¥ng hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ database?</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>1. Ki·ªÉm tra Authentication</h5>
                    </div>
                    <div class="card-body">
                        <div id="authCheck">ƒêang ki·ªÉm tra...</div>
                        <button class="btn btn-primary btn-sm mt-2" onclick="checkAuth()">Refresh</button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>2. Test API Call</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success btn-sm" onclick="testAPI()">Test /api/tests</button>
                        <div id="apiCheck" class="mt-2">Ch∆∞a test</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>3. M√¥ ph·ªèng code exam.html</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-warning" onclick="simulateExamPage()">Ch·∫°y code gi·ªëng exam.html</button>
                <div id="simulationResult" class="mt-3"></div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>4. Console Logs & Errors</h5>
            </div>
            <div class="card-body">
                <div id="consoleOutput" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace;">
                    Console logs s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
                </div>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsole()">Clear</button>
            </div>
        </div>

        <div class="mt-3">
            <a href="exam.html" class="btn btn-primary">ƒêi trang Exam</a>
            <a href="index.html" class="btn btn-warning">ƒêƒÉng nh·∫≠p l·∫°i</a>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let consoleDiv = null;

        // Override console.log to show in page
        const originalLog = console.log;
        const originalError = console.error;
        
        document.addEventListener('DOMContentLoaded', () => {
            consoleDiv = document.getElementById('consoleOutput');
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                logToPage('LOG', args.join(' '));
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                logToPage('ERROR', args.join(' '));
            };

            // Auto check auth
            checkAuth();
        });

        function logToPage(type, message) {
            if (consoleDiv) {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'ERROR' ? '#ff6b6b' : '#4ecdc4';
                consoleDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${type}: ${message}</div>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        }

        function clearConsole() {
            if (consoleDiv) consoleDiv.innerHTML = 'Console cleared...\n';
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const user = localStorage.getItem('session_user');
            
            const authDiv = document.getElementById('authCheck');
            
            if (token) {
                authDiv.innerHTML = `
                    <div class="alert alert-success p-2">
                        <strong>‚úÖ OK</strong><br>
                        <small>Token: ${token.substring(0, 20)}...</small>
                    </div>
                `;
                console.log('Auth check: Token found');
            } else {
                authDiv.innerHTML = `
                    <div class="alert alert-danger p-2">
                        <strong>‚ùå No Token</strong><br>
                        <small>Need to login</small>
                    </div>
                `;
                console.error('Auth check: No token found');
            }
        }

        async function testAPI() {
            const apiDiv = document.getElementById('apiCheck');
            apiDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testing...';
            
            try {
                console.log('Testing API /api/tests...');
                
                const headers = getAuthHeaders();
                console.log('Headers:', JSON.stringify(headers));

                const response = await fetch(`${API_BASE_URL}/tests`, { headers });
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Raw API result:', JSON.stringify(result));

                // Test data parsing logic from exam.html
                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }
                
                console.log('Parsed tests array:', tests);

                apiDiv.innerHTML = `
                    <div class="alert alert-success p-2">
                        <strong>‚úÖ API OK</strong><br>
                        <small>Found ${tests.length} tests</small>
                    </div>
                `;

            } catch (error) {
                console.error('API test failed:', error);
                apiDiv.innerHTML = `
                    <div class="alert alert-danger p-2">
                        <strong>‚ùå API Error</strong><br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        async function simulateExamPage() {
            const simDiv = document.getElementById('simulationResult');
            simDiv.innerHTML = '<div class="spinner-border"></div> Simulating exam.html logic...';

            console.log('=== SIMULATING EXAM.HTML LOGIC ===');

            try {
                // Simulate the loadExams function from exam.html
                console.log('Step 1: Showing loading...');
                
                const response = await fetch(`${API_BASE_URL}/tests`, {
                    headers: getAuthHeaders()
                });

                console.log('Step 2: API response received, status:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Step 3: 401 Unauthorized - redirecting to login');
                        simDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Would redirect to login</strong><br>
                                401 Unauthorized - token expired or invalid
                            </div>
                        `;
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Step 3: Parsing API response...', result);

                // Handle different response structures (copied from exam.html)
                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                console.log('Step 4: Parsed tests:', tests);

                if (!Array.isArray(tests) || tests.length === 0) {
                    console.log('Step 5: No tests found - showing empty state');
                    simDiv.innerHTML = `
                        <div class="alert alert-info">
                            <strong>üìù Empty result</strong><br>
                            Tests array: ${JSON.stringify(tests)}<br>
                            Would show "Ch∆∞a c√≥ ƒë·ªÅ thi n√†o kh·∫£ d·ª•ng"
                        </div>
                    `;
                    return;
                }

                // Simulate renderExams function
                console.log('Step 5: Rendering tests...');
                let activeTests = tests.filter(test => (test.status || 'active') === 'active');
                console.log('Active tests:', activeTests);

                simDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>üéâ Would render ${activeTests.length} tests!</strong><br>
                        <strong>Tests found:</strong>
                        <ol class="mb-0 mt-2">
                            ${activeTests.slice(0, 5).map(test => 
                                `<li>${test.test_name || test.name} (ID: ${test.test_id || test.id})</li>`
                            ).join('')}
                            ${activeTests.length > 5 ? `<li><em>... and ${activeTests.length - 5} more</em></li>` : ''}
                        </ol>
                    </div>
                `;

            } catch (error) {
                console.error('Simulation failed:', error);
                simDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Simulation failed</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>