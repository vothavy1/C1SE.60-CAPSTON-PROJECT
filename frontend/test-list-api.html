<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch b√†i test tuy·ªÉn d·ª•ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-indigo-800 min-h-screen text-white font-sans">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-10 border-b border-purple-400/30">
        <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-6">
            <h1 class="text-3xl font-bold text-white tracking-wide">Danh s√°ch b√†i test tuy·ªÉn d·ª•ng</h1>
            <div class="flex items-center gap-4">
                <span id="userInfo" class="font-medium text-purple-200">ƒêang t·∫£i...</span>
                <button id="loginBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                    ƒêƒÉng nh·∫≠p
                </button>
                <button id="logoutBtn" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:opacity-90 transition" style="display: none;">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </header>

    <!-- Debug Panel -->
    <div class="max-w-6xl mx-auto mt-6 p-4">
        <div id="debugPanel" class="bg-yellow-500/20 border border-yellow-400 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-yellow-200 mb-2">üîß Debug Info:</h3>
            <div id="debugContent">ƒêang ki·ªÉm tra...</div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto mt-6 p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-white">üìù Danh s√°ch b√†i test t·ª´ Database</h2>
            <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                üîÑ Refresh
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            <p class="text-white mt-2">ƒêang t·∫£i danh s√°ch b√†i test...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="bg-red-500/20 border border-red-400 rounded-lg p-6 text-center" style="display: none;">
            <h3 class="text-red-200 text-lg font-semibold mb-2">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</h3>
            <p id="errorMessage" class="text-red-300 mb-4"></p>
            <button onclick="loadTests()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                Th·ª≠ l·∫°i
            </button>
        </div>

        <!-- Tests Grid -->
        <div id="testsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
            <!-- Tests will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="bg-gray-500/20 border border-gray-400 rounded-lg p-6 text-center" style="display: none;">
            <h3 class="text-gray-200 text-lg font-semibold mb-2">üìã Ch∆∞a c√≥ b√†i test n√†o</h3>
            <p class="text-gray-300">Database ch∆∞a c√≥ d·ªØ li·ªáu b√†i test.</p>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let isLoggedIn = false;

        // DOM Elements
        const debugContent = document.getElementById('debugContent');
        const userInfo = document.getElementById('userInfo');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const testsGrid = document.getElementById('testsGrid');
        const emptyState = document.getElementById('emptyState');

        // Utility Functions
        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        function showState(state) {
            // Hide all states
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            testsGrid.style.display = 'none';
            emptyState.style.display = 'none';
            
            // Show selected state
            document.getElementById(state).style.display = 'block';
        }

        function updateDebugInfo() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const user = localStorage.getItem('session_user');
            
            let userObj = null;
            try {
                userObj = user ? JSON.parse(user) : null;
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
            
            debugContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <strong>Token:</strong> 
                        <span class="${token ? 'text-green-300' : 'text-red-300'}">
                            ${token ? '‚úÖ EXISTS' : '‚ùå MISSING'}
                        </span>
                    </div>
                    <div>
                        <strong>User:</strong> 
                        <span class="${userObj ? 'text-green-300' : 'text-red-300'}">
                            ${userObj ? `‚úÖ ${userObj.name || userObj.email}` : '‚ùå MISSING'}
                        </span>
                    </div>
                    <div>
                        <strong>Role:</strong> 
                        <span class="text-blue-300">
                            ${userObj?.role || 'N/A'}
                        </span>
                    </div>
                </div>
            `;

            // Update login state
            isLoggedIn = !!(token && userObj);
            
            if (isLoggedIn) {
                userInfo.textContent = `Xin ch√†o, ${userObj.name || userObj.email}!`;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            } else {
                userInfo.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
        }

        async function performLogin() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'havy@test.com',
                        password: '123456'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success && result.data.token) {
                    localStorage.setItem('auth_token', result.data.token);
                    localStorage.setItem('session_user', JSON.stringify(result.data.user));
                    
                    updateDebugInfo();
                    loadTests();
                    
                    alert('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                } else {
                    alert(`‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ${result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert(`‚ùå L·ªói ƒëƒÉng nh·∫≠p: ${error.message}`);
            }
        }

        function performLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('session_user');
            updateDebugInfo();
            showState('emptyState');
            emptyState.innerHTML = `
                <h3 class="text-gray-200 text-lg font-semibold mb-2">üëã ƒê√£ ƒëƒÉng xu·∫•t</h3>
                <p class="text-gray-300">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch b√†i test.</p>
            `;
        }

        async function loadTests() {
            console.log('üîÑ Loading tests...');
            showState('loadingState');

            if (!isLoggedIn) {
                showState('errorState');
                errorMessage.textContent = 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi xem danh s√°ch b√†i test.';
                return;
            }

            try {
                const headers = getAuthHeaders();
                console.log('üì§ Request headers:', headers);

                const response = await fetch(`${API_BASE_URL}/tests`, {
                    method: 'GET',
                    headers: headers
                });

                console.log('üì• Response status:', response.status);

                if (!response.ok) {
                    let errorMsg = `HTTP ${response.status}`;
                    if (response.status === 401) {
                        errorMsg = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                        performLogout();
                    } else if (response.status === 403) {
                        errorMsg = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p danh s√°ch b√†i test.';
                    } else if (response.status === 404) {
                        errorMsg = 'API endpoint kh√¥ng t·ªìn t·∫°i.';
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                console.log('üì¶ API Response:', result);

                // Parse tests data
                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                console.log(`üìä Found ${tests.length} tests`);

                if (tests.length === 0) {
                    showState('emptyState');
                    return;
                }

                renderTests(tests);
                showState('testsGrid');

            } catch (error) {
                console.error('‚ùå Load tests error:', error);
                showState('errorState');
                errorMessage.textContent = error.message;
            }
        }

        function renderTests(tests) {
            console.log('üé® Rendering tests:', tests);
            
            testsGrid.innerHTML = '';

            tests.forEach(test => {
                const testName = test.test_name || test.name || 'B√†i test kh√¥ng c√≥ t√™n';
                const testDesc = test.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
                const testId = test.test_id || test.id;
                const duration = test.duration_minutes || 60;
                const difficulty = test.difficulty_level || 'MEDIUM';
                const status = test.status || 'ACTIVE';

                // Only show active tests
                if (status !== 'ACTIVE') return;

                const testCard = document.createElement('div');
                testCard.className = 'bg-gradient-to-br from-purple-800/40 to-indigo-800/40 border border-purple-400/30 rounded-xl p-6 hover:shadow-2xl hover:scale-[1.02] transition';
                
                testCard.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-white mb-2">${testName}</h3>
                        <p class="text-purple-200 text-sm mb-3">${testDesc}</p>
                        <div class="flex flex-wrap gap-2 text-xs mb-4">
                            <span class="bg-blue-500/30 text-blue-200 px-2 py-1 rounded">‚è±Ô∏è ${duration} ph√∫t</span>
                            <span class="bg-purple-500/30 text-purple-200 px-2 py-1 rounded">üìä ${difficulty}</span>
                            <span class="bg-green-500/30 text-green-200 px-2 py-1 rounded">‚úÖ ${status}</span>
                        </div>
                    </div>
                    <button 
                        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition w-full"
                        onclick="startTest('${testId}', '${testName.replace(/'/g, "\\'")}')"
                    >
                        üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i
                    </button>
                `;

                testsGrid.appendChild(testCard);
            });
        }

        function startTest(testId, testName) {
            if (!testId) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y ID b√†i test');
                return;
            }
            
            if (confirm(`B·∫°n c√≥ mu·ªën b·∫Øt ƒë·∫ßu l√†m b√†i test "${testName}"?\n\n‚ö†Ô∏è L∆∞u √Ω: Sau khi b·∫Øt ƒë·∫ßu, b·∫°n kh√¥ng th·ªÉ tho√°t gi·ªØa ch·ª´ng.`)) {
                // Redirect to test page
                window.location.href = `test.html?testId=${testId}`;
            }
        }

        // Event Listeners
        loginBtn.addEventListener('click', performLogin);
        logoutBtn.addEventListener('click', performLogout);
        refreshBtn.addEventListener('click', loadTests);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Page loaded, initializing...');
            updateDebugInfo();
            
            if (isLoggedIn) {
                loadTests();
            } else {
                showState('errorState');
                errorMessage.textContent = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch b√†i test.';
            }
        });
    </script>
</body>
</html>