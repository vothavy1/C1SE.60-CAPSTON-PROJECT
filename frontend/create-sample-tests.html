<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm tra Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>ÔøΩ Ki·ªÉm tra Database v√† API</h2>
        
        <div class="alert alert-info">
            <strong>M·ª•c ƒë√≠ch:</strong> Ki·ªÉm tra xem database c√≥ d·ªØ li·ªáu kh√¥ng v√† API c√≥ ho·∫°t ƒë·ªông t·ªët kh√¥ng.
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>Tr·∫°ng th√°i Authentication</h5>
            </div>
            <div class="card-body">
                <div id="authStatus">ƒêang ki·ªÉm tra...</div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>Ki·ªÉm tra Database</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>üóÑÔ∏è Database ƒë√£ c√≥ s·∫µn d·ªØ li·ªáu</strong><br>
                    T·ª´ phpMyAdmin th·∫•y c√≥ 6 ƒë·ªÅ thi trong b·∫£ng `tests` (ID: 11-18).<br>
                    Kh√¥ng c·∫ßn t·∫°o th√™m mock data.
                </div>
                <button class="btn btn-primary" onclick="testDatabaseConnection()">Ki·ªÉm tra k·∫øt n·ªëi Database</button>
                <div id="createResult" class="mt-3"></div>
            </div>
        </div>

        <div class="mt-3">
            <a href="exam.html" class="btn btn-primary">V·ªÅ trang Danh s√°ch ƒë·ªÅ thi</a>
            <a href="test-list.html" class="btn btn-secondary">Qu·∫£n l√Ω ƒë·ªÅ thi (Recruiter)</a>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const userStr = localStorage.getItem('session_user');
            
            const statusDiv = document.getElementById('authStatus');
            
            if (token && userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const role = user.role ? user.role.toUpperCase() : 'UNKNOWN';
                    
                    if (role === 'RECRUITER' || role === 'ADMIN') {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ C√≥ quy·ªÅn t·∫°o ƒë·ªÅ thi</strong><br>
                                User: ${user.name || user.username || 'Unknown'}<br>
                                Role: ${role}
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Kh√¥ng c√≥ quy·ªÅn t·∫°o ƒë·ªÅ thi</strong><br>
                                Role hi·ªán t·∫°i: ${role}<br>
                                C·∫ßn role RECRUITER ho·∫∑c ADMIN
                            </div>
                        `;
                    }
                } catch (e) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå L·ªói ƒë·ªçc th√¥ng tin user</strong><br>
                            ${e.message}
                        </div>
                    `;
                }
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p</strong><br>
                        Vui l√≤ng <a href="index.html">ƒëƒÉng nh·∫≠p</a> v·ªõi t√†i kho·∫£n RECRUITER ho·∫∑c ADMIN
                    </div>
                `;
            }
        }

        async function createSampleTests() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Kh√¥ng c·∫ßn t·∫°o d·ªØ li·ªáu m·∫´u</strong><br>
                    Database ƒë√£ c√≥ s·∫µn ${getDatabaseTestCount()} ƒë·ªÅ thi. <br>
                    H√£y ki·ªÉm tra t·∫°i sao frontend kh√¥ng hi·ªÉn th·ªã ƒë∆∞·ª£c d·ªØ li·ªáu.
                </div>
            `;
            return;
        }

        function getDatabaseTestCount() {
            return "6"; // From phpMyAdmin screenshot
        }

        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = '<div class="spinner-border" role="status"></div> ƒêang ki·ªÉm tra database...';

            try {
                const response = await fetch(`${API_BASE_URL}/tests`, {
                    headers: getAuthHeaders()
                });

                console.log('Database test response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Database test result:', result);

                // Process result
                let tests = [];
                if (result.success && result.data && result.data.tests) {
                    tests = result.data.tests;
                } else if (Array.isArray(result.data)) {
                    tests = result.data;
                } else if (Array.isArray(result)) {
                    tests = result;
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Database k·∫øt n·ªëi th√†nh c√¥ng!</strong><br>
                        <strong>S·ªë ƒë·ªÅ thi t√¨m th·∫•y:</strong> ${tests.length}<br>
                        <strong>Danh s√°ch ƒë·ªÅ thi:</strong>
                        <ul class="mt-2 mb-0">
                            ${tests.slice(0, 5).map(test => 
                                `<li>ID: ${test.test_id || test.id} - ${test.test_name || test.name}</li>`
                            ).join('')}
                            ${tests.length > 5 ? `<li><em>... v√† ${tests.length - 5} ƒë·ªÅ thi kh√°c</em></li>` : ''}
                        </ul>
                        <a href="exam.html" class="btn btn-primary mt-3">Xem trang danh s√°ch ƒë·ªÅ thi</a>
                    </div>
                `;

            } catch (error) {
                console.error('Database test error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå L·ªói k·∫øt n·ªëi Database</strong><br>
                        <strong>Chi ti·∫øt:</strong> ${error.message}<br>
                        <strong>C√≥ th·ªÉ do:</strong>
                        <ul class="mt-2 mb-0">
                            <li>Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c token h·∫øt h·∫°n</li>
                            <li>Backend server kh√¥ng ho·∫°t ƒë·ªông</li>
                            <li>Database connection l·ªói</li>
                            <li>CORS ho·∫∑c API endpoint sai</li>
                        </ul>
                    </div>
                `;
            }
        }



        // Auto check auth on load
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>